Index: Bank_krwi/templates/zgloszenia_oddania.html
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>{% extends \"base.html\" %}\r\n\r\n{% block title %}Zgłoszenia i historia{% endblock %}\r\n\r\n{% block content %}\r\n\r\n<div class=\"d-flex justify-content-between align-items-center mb-4\">\r\n    <div>\r\n        <h1 class=\"fw-bold\">Centrum donacji</h1>\r\n        <p class=\"text-muted mb-0\">Planowanie i historia Twoich oddań krwi.</p>\r\n    </div>\r\n    <a href=\"/dawca\" class=\"btn btn-outline-secondary\">⬅ Powrót do panelu</a>\r\n</div>\r\n\r\n{% if error %}\r\n<div class=\"alert alert-danger shadow-sm mb-4\" role=\"alert\">\r\n    <strong>Wystąpił błąd:</strong> {{ error }}\r\n</div>\r\n{% endif %}\r\n\r\n<div class=\"row g-4\">\r\n\r\n    <div class=\"col-lg-6\">\r\n\r\n        <div class=\"card shadow mb-4 border-danger\">\r\n            <div class=\"card-header bg-danger text-white\">\r\n                <h3 class=\"h5 mb-0\">Zaplanuj oddanie krwi</h3>\r\n            </div>\r\n            <div class=\"card-body bg-light\">\r\n                <p class=\"small text-muted mb-3\">\r\n                    Wyślij zgłoszenie, aby placówka wiedziała, że planujesz wizytę.\r\n                </p>\r\n\r\n                <form method=\"POST\" class=\"row g-2 align-items-end\">\r\n                    <div class=\"col-md-8\">\r\n                        <label class=\"form-label fw-bold\">Data planowanej wizyty</label>\r\n\r\n                        <input type=\"date\"\r\n                               name=\"data_zgloszenia\"\r\n                               class=\"form-control\"\r\n                               required\r\n                               value=\"{{ sugerowana_data }}\"\r\n                               min=\"{{ sugerowana_data }}\">\r\n\r\n                        <div class=\"form-text small text-muted\">\r\n                            System automatycznie wyliczył najbliższy bezpieczny termin (wymagana przerwa 56 dni).\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-4\">\r\n                        <button type=\"submit\" class=\"btn btn-krew w-100\">\r\n                            Wyślij zgłoszenie\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"card shadow\">\r\n            <div class=\"card-header bg-white\">\r\n                <h3 class=\"h5 mb-0 text-muted\">Twoje aktywne zgłoszenia</h3>\r\n            </div>\r\n            <div class=\"card-body p-0\">\r\n                {% if zgloszenia %}\r\n                <div class=\"table-responsive\">\r\n                    <table class=\"table table-hover align-middle mb-0\">\r\n                        <thead class=\"table-light\">\r\n                        <tr>\r\n                            <th>Data</th>\r\n                            <th>Status</th>\r\n                            <th class=\"text-end\">Akcje</th>\r\n                        </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                        {% for z in zgloszenia %}\r\n                        <tr>\r\n                            <td class=\"fw-bold\">{{ z[1] }}</td>\r\n\r\n                            <td>\r\n                                {% if z[2] == 'oczekujace' %}\r\n                                <span class=\"badge bg-warning text-dark\">OCZEKUJĄCE</span>\r\n                                {% elif z[2] == 'zaakceptowane' %}\r\n                                <span class=\"badge bg-success\">ZAAKCEPTOWANE</span>\r\n                                {% else %}\r\n                                <span class=\"badge bg-secondary\">{{ z[2] }}</span>\r\n                                {% endif %}\r\n                            </td>\r\n\r\n                            <td class=\"text-end\">\r\n                                {% if z[2] == 'oczekujace' %}\r\n                                <form method=\"POST\" action=\"/dawca/zgloszenia-oddania/usun/{{ z[0] }}\">\r\n                                    <button type=\"submit\" class=\"btn btn-sm btn-outline-danger\"\r\n                                            onclick=\"return confirm('Czy na pewno chcesz wycofać to zgłoszenie?');\">\r\n                                        Usuń\r\n                                    </button>\r\n                                </form>\r\n                                {% else %}\r\n                                <span class=\"text-muted small\">—</span>\r\n                                {% endif %}\r\n                            </td>\r\n                        </tr>\r\n                        {% endfor %}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                {% else %}\r\n                <div class=\"p-4 text-center text-muted\">\r\n                    Brak aktywnych zgłoszeń. Zaplanuj wizytę powyżej!\r\n                </div>\r\n                {% endif %}\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"col-lg-6\">\r\n        <div class=\"card shadow h-100\">\r\n            <div class=\"card-header bg-dark text-white d-flex justify-content-between align-items-center\">\r\n                <h3 class=\"h5 mb-0\">Historia donacji</h3>\r\n                <span class=\"badge bg-secondary\">{{ oddania|length }} wizyt</span>\r\n            </div>\r\n\r\n            <div class=\"card-body p-0\">\r\n                {% if oddania %}\r\n                <div class=\"table-responsive\">\r\n                    <table class=\"table table-striped table-hover align-middle mb-0\">\r\n                        <thead>\r\n                        <tr>\r\n                            <th>Data donacji</th>\r\n                            <th class=\"text-end\">Ilość krwi</th>\r\n                        </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                        {% for o in oddania %}\r\n                        <tr>\r\n                            <td>\r\n                                {{ o[1] }}\r\n                            </td>\r\n                            <td class=\"text-end\">\r\n                                <span class=\"badge bg-krew fs-6\">{{ o[0] }} ml</span>\r\n                            </td>\r\n                        </tr>\r\n                        {% endfor %}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n                {% else %}\r\n                <div class=\"text-center py-5\">\r\n                    <div class=\"mb-3 fs-1 text-muted\">\uD83E\uDE78</div>\r\n                    <h5 class=\"text-muted\">Brak historii oddań</h5>\r\n                    <p class=\"text-muted small mb-0\">\r\n                        Twoja historia pojawi się tutaj po pierwszej wizycie w punkcie krwiodawstwa.\r\n                    </p>\r\n                </div>\r\n                {% endif %}\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n</div>\r\n\r\n{% endblock %}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/Bank_krwi/templates/zgloszenia_oddania.html b/Bank_krwi/templates/zgloszenia_oddania.html
--- a/Bank_krwi/templates/zgloszenia_oddania.html	(revision a05326d4c698d9c3abb0bc07c5796039845a2e9c)
+++ b/Bank_krwi/templates/zgloszenia_oddania.html	(date 1768491122367)
@@ -78,8 +78,8 @@
                             <td>
                                 {% if z[2] == 'oczekujace' %}
                                 <span class="badge bg-warning text-dark">OCZEKUJĄCE</span>
-                                {% elif z[2] == 'zaakceptowane' %}
-                                <span class="badge bg-success">ZAAKCEPTOWANE</span>
+                                {% elif z[2] == 'zrealizowane' %}
+                                <span class="badge bg-success">ZREALIZOWANE</span>
                                 {% else %}
                                 <span class="badge bg-secondary">{{ z[2] }}</span>
                                 {% endif %}
Index: Bank_krwi/templates/register.html
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>{% extends \"base.html\" %}\r\n\r\n{% block title %}Rejestracja dawcy{% endblock %}\r\n\r\n{% block content %}\r\n\r\n<div class=\"row justify-content-center mt-4 mb-5\">\r\n    <div class=\"col-md-8 col-lg-6\">\r\n\r\n        <div class=\"card shadow\">\r\n            <div class=\"card-header bg-krew text-white text-center py-3\">\r\n                <h2 class=\"h4 mb-0\">Rejestracja nowego dawcy</h2>\r\n            </div>\r\n\r\n            <div class=\"card-body p-4\">\r\n                <form method=\"POST\">\r\n\r\n                    <h5 class=\"text-danger border-bottom pb-2 mb-3\">1. Dane logowania</h5>\r\n                    <div class=\"row g-3 mb-4\">\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Login</label>\r\n                            <input type=\"text\" name=\"login\" class=\"form-control\" placeholder=\"Wymyśl login\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Hasło</label>\r\n                            <input type=\"password\" name=\"haslo\" class=\"form-control\" placeholder=\"••••••••\" required>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <h5 class=\"text-danger border-bottom pb-2 mb-3\">2. Dane osobowe</h5>\r\n                    <div class=\"row g-3 mb-3\">\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Imię</label>\r\n                            <input type=\"text\" name=\"imie\" class=\"form-control\" required>\r\n                        </div>\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Nazwisko</label>\r\n                            <input type=\"text\" name=\"nazwisko\" class=\"form-control\" required>\r\n                        </div>\r\n\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">PESEL</label>\r\n                            <input type=\"text\" name=\"pesel\" class=\"form-control\" maxlength=\"11\" required>\r\n                            <div class=\"form-text small\">Potrzebny do identyfikacji medycznej.</div>\r\n                        </div>\r\n\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Kontakt</label>\r\n                            <input type=\"text\" name=\"kontakt\" class=\"form-control\" placeholder=\"Telefon lub e-mail\" required>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <h5 class=\"text-danger border-bottom pb-2 mb-3 mt-4\">3. Dane medyczne</h5>\r\n                    <div class=\"row g-3 mb-4\">\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Grupa krwi</label>\r\n                            <select name=\"grupa\" class=\"form-select\" required>\r\n                                <option value=\"\" disabled selected>Wybierz...</option>\r\n                                <option value=\"A\">A</option>\r\n                                <option value=\"B\">B</option>\r\n                                <option value=\"AB\">AB</option>\r\n                                <option value=\"0\">0</option>\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div class=\"col-md-6\">\r\n                            <label class=\"form-label fw-bold\">Czynnik Rh</label>\r\n                            <select name=\"rh\" class=\"form-select\" required>\r\n                                <option value=\"\" disabled selected>Wybierz...</option>\r\n                                <option value=\"+\">Rh+ (dodatni)</option>\r\n                                <option value=\"-\">Rh- (ujemny)</option>\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"d-grid gap-2 mt-4\">\r\n                        <button type=\"submit\" class=\"btn btn-krew btn-lg\">\r\n                            Zarejestruj się\r\n                        </button>\r\n                    </div>\r\n\r\n                </form>\r\n            </div>\r\n\r\n            <div class=\"card-footer bg-light text-center py-3\">\r\n                <span class=\"text-muted\">Masz już konto?</span>\r\n                <a href=\"/login\" class=\"fw-bold text-decoration-none ms-1\">Zaloguj się</a>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n{% endblock %}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/Bank_krwi/templates/register.html b/Bank_krwi/templates/register.html
--- a/Bank_krwi/templates/register.html	(revision a05326d4c698d9c3abb0bc07c5796039845a2e9c)
+++ b/Bank_krwi/templates/register.html	(date 1768606101248)
@@ -19,7 +19,12 @@
                     <div class="row g-3 mb-4">
                         <div class="col-md-6">
                             <label class="form-label fw-bold">Login</label>
-                            <input type="text" name="login" class="form-control" placeholder="Wymyśl login" required>
+                            <input type="text" name="login" class="form-control {{'is-invalid' if error }}" placeholder="Wymyśl login" required>
+                            {% if error %}
+                            <div class="invalid-feedback">
+                                {{ error }}
+                            </div>
+                            {% endif %}
                         </div>
                         <div class="col-md-6">
                             <label class="form-label fw-bold">Hasło</label>
@@ -46,7 +51,7 @@
 
                         <div class="col-md-6">
                             <label class="form-label fw-bold">Kontakt</label>
-                            <input type="text" name="kontakt" class="form-control" placeholder="Telefon lub e-mail" required>
+                            <input type="text" name="kontakt" class="form-control" placeholder="Numer telefonu 9-cyfrowy" maxlength="9" required>
                         </div>
                     </div>
 
Index: Bank_krwi/app.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>from flask import Flask, render_template, request, redirect, session, url_for, flash\r\nfrom db.connection import get_db\r\nfrom functools import wraps\r\nimport psycopg2\r\nfrom datetime import date, timedelta\r\n\r\napp = Flask(__name__)\r\napp.secret_key = \"koko\"   # zmień na swój\r\n\r\ndef login_required(role=None):\r\n    def decorator(f):\r\n        @wraps(f)\r\n        def wrapper(*args, **kwargs):\r\n            # brak sesji → przekierowanie na login\r\n            if \"user_id\" not in session:\r\n                return redirect(\"/login\")\r\n\r\n            # jeśli podano wymaganą rolę → sprawdzamy\r\n            if role and session.get(\"rola\") != role:\r\n                return redirect(\"/login\")\r\n\r\n            return f(*args, **kwargs)\r\n        return wrapper\r\n    return decorator\r\n@app.route(\"/\")\r\ndef index():\r\n    return redirect(\"/login\")\r\n\r\n@app.route(\"/login\", methods=[\"GET\", \"POST\"])\r\ndef login():\r\n    error = None\r\n\r\n    if request.method == \"POST\":\r\n        login = request.form[\"login\"]\r\n        haslo = request.form[\"haslo\"]\r\n\r\n        conn = get_db()\r\n        cur = conn.cursor()\r\n\r\n        cur.execute(\"\"\"\r\n                    SELECT id_uzytkownika, rola\r\n                    FROM Uzytkownicy\r\n                    WHERE login = %s\r\n                      AND haslo = public.crypt(%s, haslo)\r\n                    \"\"\", (login, haslo))\r\n\r\n        user = cur.fetchone()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        if user:\r\n            session[\"user_id\"] = user[0]\r\n            session[\"rola\"] = user[1]\r\n            session[\"login\"] = login\r\n\r\n            return redirect(\"/welcome\")\r\n\r\n        else:\r\n            error = \"Niepoprawny login lub hasło\"\r\n\r\n    return render_template(\"login.html\", error=error)\r\n\r\n@app.route(\"/register\", methods=[\"GET\", \"POST\"])\r\ndef register():\r\n    error = None\r\n\r\n    if request.method == \"POST\":\r\n        login = request.form[\"login\"]\r\n        haslo = request.form[\"haslo\"]\r\n        imie = request.form[\"imie\"]\r\n        nazwisko = request.form[\"nazwisko\"]\r\n        pesel = request.form[\"pesel\"]\r\n        grupa = request.form[\"grupa\"]\r\n        rh = request.form[\"rh\"]\r\n        kontakt = request.form[\"kontakt\"]\r\n\r\n        conn = get_db()\r\n        cur = conn.cursor()\r\n\r\n        #dodanie użytkownika\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO uzytkownicy (login, haslo, rola, data_rejestracji)\r\n                    VALUES (%s, public.crypt(%s, public.gen_salt('bf')), 'DAWCA', CURRENT_DATE)\r\n                        RETURNING id_uzytkownika;\r\n                    \"\"\", (login, haslo))\r\n\r\n        id_uzytkownika = cur.fetchone()[0]\r\n\r\n        #dodanie dawcy\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika)\r\n                    VALUES (%s, %s, %s, %s, %s, %s, %s);\r\n                    \"\"\", (imie, nazwisko, pesel, grupa, rh, kontakt, id_uzytkownika))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        #automatyczne logowanie po rejestracji\r\n        session[\"user_id\"] = id_uzytkownika\r\n        session[\"rola\"] = \"DAWCA\"\r\n\r\n        return redirect(\"/welcome\")\r\n\r\n    return render_template(\"register.html\", error=error)\r\n\r\n\r\n@app.route(\"/welcome\")\r\n@login_required()\r\ndef welcome():\r\n    rola = session.get(\"rola\")\r\n    return render_template(\"welcome.html\", rola=rola)\r\n\r\n@app.route(\"/dawca\")\r\n@login_required(role=\"DAWCA\")\r\ndef panel_dawcy():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # 1. Główne dane dawcy\r\n    cur.execute(\"\"\"\r\n                SELECT\r\n                    d.imie,\r\n                    d.nazwisko,\r\n                    d.grupa_krwi,\r\n                    d.rh,\r\n                    COUNT(o.id_oddania) AS liczba_oddan,\r\n                    (\r\n                        SELECT z.status\r\n                        FROM zgloszenia z\r\n                        WHERE z.id_dawcy = d.id_dawcy\r\n                          AND z.data_zgloszenia >= CURRENT_DATE\r\n                        ORDER BY z.data_zgloszenia ASC\r\n                                           LIMIT 1\r\n                    ) AS status_przyszlego_zgloszenia, -- Zmieniłem nazwę, bo to jest status, a nie data\r\n                    d.id_dawcy\r\n                FROM dawcy d\r\n                    LEFT JOIN oddania_krwi o ON o.id_dawcy = d.id_dawcy\r\n                WHERE d.id_uzytkownika = %s\r\n                GROUP BY d.id_dawcy, d.imie, d.nazwisko, d.grupa_krwi, d.rh;\r\n                \"\"\", (user_id,))\r\n\r\n    dane = cur.fetchone()\r\n\r\n    # Zabezpieczenie, gdyby nie było dawcy\r\n    if not dane:\r\n        cur.close()\r\n        conn.close()\r\n        return \"Brak profilu dawcy\", 400\r\n\r\n    id_dawcy = dane[6]\r\n\r\n    # 2. Cel dawcy\r\n    cur.execute(\"\"\"\r\n                SELECT cel_ml\r\n                FROM dawcy\r\n                WHERE id_dawcy = %s;\r\n                \"\"\", (id_dawcy,))\r\n    row_cel = cur.fetchone() # Lepiej pobrać wiersz i sprawdzić\r\n    cel = row_cel[0] if row_cel else 0\r\n\r\n    # 3. Suma ml z widoku\r\n    cur.execute(\"\"\"\r\n                SELECT suma_ml\r\n                FROM widok_suma_ml\r\n                WHERE id_dawcy = %s;\r\n                \"\"\", (id_dawcy,))\r\n    suma = cur.fetchone()\r\n    suma_ml = suma[0] if suma else 0 # Jeśli None to 0\r\n\r\n    # 4. Daty oddań z widoku (Tu jest Twoje 'ostatnie')\r\n    cur.execute(\"\"\"\r\n                SELECT pierwsze_oddanie, ostatnie_oddanie\r\n                FROM widok_dat_oddan\r\n                WHERE id_dawcy = %s;\r\n                \"\"\", (id_dawcy,))\r\n    daty = cur.fetchone()\r\n    pierwsze = daty[0] if daty else None\r\n    ostatnie = daty[1] if daty else None\r\n\r\n    # ---------------------------------------------------------\r\n    # NOWOŚĆ: Obliczanie daty kolejnego oddania (+56 dni)\r\n    # ---------------------------------------------------------\r\n    najblizszy_termin = None  # Domyślnie None -> HTML wyświetli \"Teraz!\"\r\n\r\n    if ostatnie:\r\n        # Dodajemy 8 tygodni (56 dni) do ostatniej daty\r\n        wymagana_przerwa = ostatnie + timedelta(days=56)\r\n\r\n        # Jeśli ta data jest w przyszłości, to ją przekazujemy.\r\n        # Jeśli jest dzisiaj lub minęła, zostawiamy None (czyli można oddać teraz)\r\n        if wymagana_przerwa > date.today():\r\n            najblizszy_termin = wymagana_przerwa\r\n    # ---------------------------------------------------------\r\n\r\n    # 5. Historia badań z widoku\r\n    cur.execute(\"\"\"\r\n                SELECT data_badania, rodzaj_badania, wynik\r\n                FROM widok_historia_badania\r\n                WHERE dawca = %s\r\n                ORDER BY data_badania DESC;\r\n                \"\"\", (f\"{dane[0]} {dane[1]}\",))\r\n\r\n    historia_badan = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"panel_dawcy.html\",\r\n        imie=dane[0],\r\n        nazwisko=dane[1],\r\n        grupa=dane[2],\r\n        rh=dane[3],\r\n        liczba_oddan=dane[4],\r\n\r\n        # Tutaj najważniejsza zmiana: przekazujemy obliczoną datę, a nie status z SQL\r\n        najblizsze=najblizszy_termin,\r\n\r\n        suma_ml=suma_ml,\r\n        cel_ml=cel,\r\n        pierwsze=pierwsze,\r\n        ostatnie=ostatnie,\r\n        historia_badan=historia_badan\r\n    )\r\n@app.route(\"/dawca/dane\")\r\n@login_required(role=\"DAWCA\")\r\ndef dane_dawcy():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT imie, nazwisko, pesel, grupa_krwi, rh, kontakt\r\n                FROM dawcy\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n\r\n    dane = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"dane_dawcy.html\",\r\n        imie=dane[0],\r\n        nazwisko=dane[1],\r\n        pesel=dane[2],\r\n        grupa=dane[3],\r\n        rh=dane[4],\r\n        kontakt=dane[5]\r\n    )\r\n\r\n@app.route(\"/dawca/dane/edytuj\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"DAWCA\")\r\ndef edytuj_dane_dawcy():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie aktualnych danych dawcy\r\n    cur.execute(\"\"\"\r\n                SELECT imie, nazwisko, pesel, grupa_krwi, rh, kontakt\r\n                FROM dawcy\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    dane = cur.fetchone()\r\n\r\n    if request.method == \"POST\":\r\n        imie = request.form[\"imie\"]\r\n        nazwisko = request.form[\"nazwisko\"]\r\n        pesel = request.form[\"pesel\"]\r\n        kontakt = request.form[\"kontakt\"]\r\n\r\n        cur.execute(\"\"\"\r\n                    UPDATE dawcy\r\n                    SET imie = %s,\r\n                        nazwisko = %s,\r\n                        pesel = %s,\r\n                        kontakt = %s\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (imie, nazwisko, pesel, kontakt, user_id))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        return redirect(\"/dawca/dane\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"edytuj_dane_dawcy.html\",\r\n        imie=dane[0],\r\n        nazwisko=dane[1],\r\n        pesel=dane[2],\r\n        kontakt=dane[5]\r\n    )\r\n\r\n\r\n@app.route(\"/dawca/zgloszenia-oddania\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"DAWCA\")\r\ndef zgloszenia_oddania():\r\n    user_id = session[\"user_id\"]\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id_dawcy\r\n    cur.execute(\"\"\"\r\n                SELECT id_dawcy\r\n                FROM dawcy\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    row = cur.fetchone()\r\n\r\n    if not row:\r\n        cur.close()\r\n        conn.close()\r\n        return \"Brak powiązanego dawcy dla tego użytkownika\", 400\r\n\r\n    id_dawcy = row[0]\r\n\r\n    # ---------------------------------------------------------\r\n    # NOWOŚĆ: Obliczanie sugerowanej daty (56 dni przerwy)\r\n    # Robimy to TUTAJ, żeby zmienna była dostępna i dla GET, i dla POST (w razie błędu)\r\n    # ---------------------------------------------------------\r\n    cur.execute(\"SELECT MAX(data_oddania) FROM oddania_krwi WHERE id_dawcy = %s\", (id_dawcy,))\r\n    wynik_daty = cur.fetchone()\r\n    ostatnia_data = wynik_daty[0] if wynik_daty else None\r\n\r\n    if ostatnia_data:\r\n        sugerowana_data = ostatnia_data + timedelta(days=56)\r\n        # Jeśli termin już minął, sugerujemy dzisiaj\r\n        if sugerowana_data < date.today():\r\n            sugerowana_data = date.today()\r\n    else:\r\n        # Jeśli nigdy nie oddawał, może oddać dzisiaj\r\n        sugerowana_data = date.today()\r\n    # ---------------------------------------------------------\r\n\r\n    # Obsługa formularza (POST)\r\n    if request.method == \"POST\":\r\n        data_zgloszenia = request.form.get(\"data_zgloszenia\")\r\n\r\n        if not data_zgloszenia:\r\n            # Jeśli user nic nie wybrał, wstawiamy dzisiejszą (lub sugerowaną)\r\n            data_zgloszenia = date.today()\r\n\r\n        try:\r\n            cur.execute(\"\"\"\r\n                        INSERT INTO zgloszenia (id_dawcy, data_zgloszenia, status)\r\n                        VALUES (%s, %s, 'oczekujace');\r\n                        \"\"\", (id_dawcy, data_zgloszenia))\r\n            conn.commit()\r\n\r\n            cur.close()\r\n            conn.close()\r\n            return redirect(\"/dawca/zgloszenia-oddania\")\r\n\r\n        except psycopg2.Error as e:\r\n            conn.rollback()\r\n            error_message = str(e).split(\"CONTEXT\")[0].replace(\"ERROR:\", \"\").strip()\r\n\r\n            # Pobieramy dane ponownie, żeby wyświetlić stronę z błędem\r\n            cur.execute(\"\"\"\r\n                        SELECT id_zgloszenia, data_zgloszenia, status\r\n                        FROM zgloszenia\r\n                        WHERE id_dawcy = %s\r\n                        ORDER BY data_zgloszenia DESC;\r\n                        \"\"\", (id_dawcy,))\r\n            zgloszenia = cur.fetchall()\r\n\r\n            cur.execute(\"\"\"\r\n                        SELECT ilosc_ml, data_oddania\r\n                        FROM oddania_krwi\r\n                        WHERE id_dawcy = %s\r\n                        ORDER BY data_oddania DESC;\r\n                        \"\"\", (id_dawcy,))\r\n            oddania = cur.fetchall()\r\n\r\n            cur.close()\r\n            conn.close()\r\n\r\n            return render_template(\r\n                \"zgloszenia_oddania.html\",\r\n                error=error_message,\r\n                zgloszenia=zgloszenia,\r\n                oddania=oddania,\r\n                sugerowana_data=sugerowana_data  # <--- Przekazujemy datę przy błędzie\r\n            )\r\n\r\n    # -------------------------\r\n    # CZĘŚĆ GET — normalne wyświetlanie strony\r\n    # -------------------------\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT id_zgloszenia, data_zgloszenia, status\r\n                FROM zgloszenia\r\n                WHERE id_dawcy = %s\r\n                ORDER BY data_zgloszenia DESC;\r\n                \"\"\", (id_dawcy,))\r\n    zgloszenia = cur.fetchall()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT ilosc_ml, data_oddania\r\n                FROM oddania_krwi\r\n                WHERE id_dawcy = %s\r\n                ORDER BY data_oddania DESC;\r\n                \"\"\", (id_dawcy,))\r\n    oddania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"zgloszenia_oddania.html\",\r\n        zgloszenia=zgloszenia,\r\n        oddania=oddania,\r\n        sugerowana_data=sugerowana_data # <--- Przekazujemy datę do widoku\r\n    )\r\n\r\n@app.route(\"/dawca/zgloszenia-oddania/usun/<int:id_zgloszenia>\", methods=[\"POST\"])\r\n@login_required(role=\"DAWCA\")\r\ndef usun_zgloszenie(id_zgloszenia):\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # upewniamy się, że zgłoszenie należy do tego dawcy i jest oczekujące\r\n    cur.execute(\"\"\"\r\n                DELETE FROM zgloszenia\r\n                WHERE id_zgloszenia = %s\r\n                  AND id_dawcy = (SELECT id_dawcy FROM dawcy WHERE id_uzytkownika = %s)\r\n                  AND status = 'oczekujace';\r\n                \"\"\", (id_zgloszenia, user_id))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/dawca/zgloszenia-oddania\")\r\n\r\n@app.route(\"/dawca/cel\", methods=[\"POST\"])\r\n@login_required(role=\"DAWCA\")\r\ndef ustaw_cel():\r\n    user_id = session[\"user_id\"]\r\n    cel = request.form[\"cel\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                UPDATE dawcy\r\n                SET cel_ml = %s\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (cel, user_id))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/dawca\")\r\n\r\n@app.route(\"/dawca/przekazania\")\r\n@login_required(role=\"DAWCA\")\r\ndef przekazania():\r\n    user_id = session[\"user_id\"]\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id_dawcy\r\n    cur.execute(\"\"\"\r\n                SELECT id_dawcy\r\n                FROM dawcy\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_dawcy = cur.fetchone()[0]\r\n\r\n    # Pobranie danych z widoku\r\n    cur.execute(\"\"\"\r\n                SELECT szpital, data_przekazania, ilosc_oddana\r\n                FROM widok_dawcy_szpitale\r\n                WHERE id_dawcy = %s\r\n                ORDER BY data_przekazania DESC;\r\n                \"\"\", (id_dawcy,))\r\n    przekazania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"przekazania.html\", przekazania=przekazania)\r\n\r\n\r\n\r\n@app.route(\"/pracownik\")\r\n@login_required(role=\"PRACOWNIK\")\r\ndef panel_pracownika():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobieramy alarmujące zapotrzebowania\r\n    cur.execute(\"SELECT * FROM Widok_zapotrzebowania_duze\")\r\n    pilne_zapotrzebowania = cur.fetchall()\r\n\r\n    # Pobranie danych pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT p.id_pracownika, p.imie, p.nazwisko, p.stanowisko\r\n                FROM pracownicy_banku p\r\n                WHERE p.id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    pracownik = cur.fetchone()\r\n\r\n    if not pracownik:\r\n        cur.close()\r\n        conn.close()\r\n        return \"Brak danych pracownika\", 400\r\n\r\n    id_pracownika = pracownik[0]\r\n\r\n    # Pobranie statystyk z widoku widok_pracownicy_aktywnosc\r\n    cur.execute(\"\"\"\r\n                SELECT liczba_oddan, liczba_badan, liczba_zapotrzebowan\r\n                FROM widok_pracownicy_aktywnosc\r\n                WHERE id_pracownika = %s;\r\n                \"\"\", (id_pracownika,))\r\n    statystyki = cur.fetchone()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"panel_pracownika.html\",\r\n        imie=pracownik[1],\r\n        nazwisko=pracownik[2],\r\n        stanowisko=pracownik[3],\r\n        oddania=statystyki[0] if statystyki else 0,\r\n        badania=statystyki[1] if statystyki else 0,\r\n        zapotrzebowania=statystyki[2] if statystyki else 0,\r\n        alerts=pilne_zapotrzebowania\r\n    )\r\n\r\n@app.route(\"/pracownik/dane\")\r\n@login_required(role=\"PRACOWNIK\")\r\ndef dane_pracownika():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT imie, nazwisko, stanowisko\r\n                FROM pracownicy_banku\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n\r\n    dane = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"dane_pracownika.html\",\r\n        imie=dane[0],\r\n        nazwisko=dane[1],\r\n        stanowisko=dane[2],\r\n    )\r\n\r\n@app.route(\"/pracownik/dane/edytuj\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef edytuj_dane_pracownika():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie aktualnych danych pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT imie, nazwisko, stanowisko\r\n                FROM pracownicy_banku\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    dane = cur.fetchone()\r\n\r\n    if request.method == \"POST\":\r\n        imie = request.form[\"imie\"]\r\n        nazwisko = request.form[\"nazwisko\"]\r\n        stanowisko = request.form[\"stanowisko\"]\r\n\r\n        cur.execute(\"\"\"\r\n                    UPDATE pracownicy_banku\r\n                    SET imie = %s,\r\n                        nazwisko = %s,\r\n                        stanowisko = %s\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (imie, nazwisko, stanowisko, user_id))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        return redirect(\"/pracownik/dane\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"edytuj_dane_pracownika.html\",\r\n        imie=dane[0],\r\n        nazwisko=dane[1],\r\n        stanowisko=dane[2]\r\n    )\r\n\r\n@app.route(\"/pracownik/badania\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef badania():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id_pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT id_pracownika\r\n                FROM pracownicy_banku\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_pracownika = cur.fetchone()[0]\r\n\r\n    # Dodawanie badania\r\n    if request.method == \"POST\":\r\n        id_oddania = request.form[\"id_oddania\"]\r\n        rodzaj = request.form[\"rodzaj\"]\r\n        wynik = request.form[\"wynik\"]\r\n        data_badania = request.form[\"data_badania\"]\r\n\r\n        # WALIDACJA: data nie może być z przyszłości\r\n        if data_badania > str(date.today()):\r\n            cur.close()\r\n            conn.close()\r\n            return \"Data badania nie może być z przyszłości.\", 400\r\n\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO badania (id_oddania, id_pracownika, rodzaj_badania, wynik, data_badania)\r\n                    VALUES (%s, %s, %s, %s, %s);\r\n                    \"\"\", (id_oddania, id_pracownika, rodzaj, wynik, data_badania))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n        return redirect(\"/pracownik/badania\")\r\n\r\n    # Pobranie badań z widoku\r\n    cur.execute(\"\"\"\r\n                SELECT id_badania, id_oddania, dawca, rodzaj_badania, wynik, data_badania, id_pracownika\r\n                FROM widok_historia_badania\r\n                ORDER BY data_badania DESC;\r\n                \"\"\")\r\n    badania = cur.fetchall()\r\n\r\n    # Pobranie statystyk\r\n    cur.execute(\"SELECT negatywne, pozytywne FROM widok_statystyki_badan;\")\r\n    negatywne, pozytywne = cur.fetchone()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"badania.html\",\r\n        badania=badania,\r\n        id_pracownika=id_pracownika,\r\n        negatywne=negatywne,\r\n        pozytywne=pozytywne,\r\n        today=date.today()  # ← potrzebne do max=\"...\"\r\n    )\r\n\r\n\r\nfrom datetime import date\r\n\r\n@app.route(\"/pracownik/badania/edytuj/<int:id_badania>\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef edytuj_badanie(id_badania):\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id_pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT id_pracownika\r\n                FROM pracownicy_banku\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_pracownika = cur.fetchone()[0]\r\n\r\n    # Pobranie badania TYLKO jeśli należy do pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT id_badania, id_oddania, rodzaj_badania, wynik, data_badania\r\n                FROM badania\r\n                WHERE id_badania = %s\r\n                  AND id_pracownika = %s;\r\n                \"\"\", (id_badania, id_pracownika))\r\n    badanie = cur.fetchone()\r\n\r\n    if not badanie:\r\n        cur.close()\r\n        conn.close()\r\n        return \"Nie masz uprawnień do edycji tego badania.\", 403\r\n\r\n    # Obsługa formularza\r\n    if request.method == \"POST\":\r\n        rodzaj = request.form[\"rodzaj\"]\r\n        wynik = request.form[\"wynik\"]\r\n        data_badania = request.form[\"data_badania\"]\r\n\r\n        # WALIDACJA: data nie może być z przyszłości\r\n        if data_badania > str(date.today()):\r\n            cur.close()\r\n            conn.close()\r\n            return \"Data badania nie może być z przyszłości.\", 400\r\n\r\n        cur.execute(\"\"\"\r\n                    UPDATE badania\r\n                    SET rodzaj_badania = %s,\r\n                        wynik = %s,\r\n                        data_badania = %s\r\n                    WHERE id_badania = %s\r\n                      AND id_pracownika = %s;\r\n                    \"\"\", (rodzaj, wynik, data_badania, id_badania, id_pracownika))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n        return redirect(\"/pracownik/badania\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"edytuj_badanie.html\",\r\n        badanie=badanie,\r\n        today=date.today()  # ← potrzebne do max=\"...\"\r\n    )\r\n\r\n\r\n\r\n@app.route(\"/pracownik/badania/usun/<int:id_badania>\")\r\n@login_required(role=\"PRACOWNIK\")\r\ndef usun_badanie(id_badania):\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"DELETE FROM badania WHERE id_badania = %s;\", (id_badania,))\r\n    conn.commit()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/pracownik/badania\")\r\n\r\n@app.route(\"/pracownik/oddania\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef oddania():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id_pracownika\r\n    cur.execute(\"\"\"\r\n                SELECT id_pracownika\r\n                FROM pracownicy_banku\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_pracownika = cur.fetchone()[0]\r\n\r\n    error = None\r\n\r\n    cur.execute(\"SELECT srednia_ml FROM widok_srednia_ilosc;\")\r\n    srednia = cur.fetchone()[0]\r\n\r\n    # Dodawanie oddania\r\n    if request.method == \"POST\":\r\n        pesel = request.form[\"pesel\"]\r\n        ilosc_ml = request.form[\"ilosc_ml\"]\r\n        data_oddania = request.form[\"data_oddania\"]\r\n\r\n        # 1. Walidacja daty\r\n        if data_oddania > str(date.today()):\r\n            error = \"Data oddania nie może być z przyszłości.\"\r\n        else:\r\n            try:\r\n                # 2. Szukamy ID dawcy na podstawie PESEL\r\n                cur.execute(\"SELECT id_dawcy FROM Dawcy WHERE pesel = %s;\", (pesel,))\r\n                dawca = cur.fetchone()\r\n\r\n                if not dawca:\r\n                    error = \"Nie znaleziono dawcy o podanym numerze PESEL.\"\r\n                else:\r\n                    id_dawcy = dawca[0] # Wyciągamy ID z krotki\r\n\r\n                    # 3. Próba zapisu oddania\r\n                    # Używamy znalezionego id_dawcy\r\n                    cur.execute(\"\"\"\r\n                                INSERT INTO oddania_krwi (id_dawcy, id_pracownika, ilosc_ml, data_oddania, ilosc_pozostala)\r\n                                VALUES (%s, %s, %s, %s, %s);\r\n                                \"\"\", (id_dawcy, id_pracownika, ilosc_ml, data_oddania, ilosc_ml))\r\n\r\n                    conn.commit()\r\n                    cur.close()\r\n                    conn.close()\r\n                    return redirect(\"/pracownik/oddania\")\r\n\r\n            except Exception as e:\r\n                conn.rollback()\r\n                error = f\"Błąd bazy danych: {str(e).splitlines()[0]}\"\r\n\r\n    # Pobranie oddań\r\n    cur.execute(\"\"\"\r\n                SELECT\r\n                    o.id_oddania,\r\n                    d.imie || ' ' || d.nazwisko AS dawca,\r\n                    d.grupa_krwi,\r\n                    d.rh,\r\n                    o.ilosc_ml,\r\n                    o.data_oddania,\r\n                    o.data_waznosci\r\n                FROM oddania_krwi o\r\n                         JOIN dawcy d ON o.id_dawcy = d.id_dawcy\r\n                ORDER BY o.id_oddania DESC;\r\n                \"\"\")\r\n    oddania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"oddania.html\", oddania=oddania, error=error, srednia=srednia)\r\n\r\n@app.route(\"/pracownik/oddania/edytuj/<int:id_oddania>\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef edytuj_oddanie(id_oddania):\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie danych oddania\r\n    cur.execute(\"\"\"\r\n                SELECT id_oddania, id_dawcy, ilosc_ml, data_oddania, ilosc_pozostala\r\n                FROM oddania_krwi\r\n                WHERE id_oddania = %s;\r\n                \"\"\", (id_oddania,))\r\n    oddanie = cur.fetchone()\r\n\r\n    if request.method == \"POST\":\r\n        ilosc_ml = request.form[\"ilosc_ml\"]\r\n        data_oddania = request.form[\"data_oddania\"]\r\n        ilosc_pozostala = oddanie[4]\r\n\r\n        # 1. Walidacja daty\r\n        if data_oddania > str(date.today()):\r\n            cur.close()\r\n            conn.close()\r\n            return render_template(\r\n                \"edytuj_oddanie.html\",\r\n                oddanie=oddanie,\r\n                error=\"Data oddania nie może być z przyszłości.\"\r\n            )\r\n\r\n        # 2. Walidacja ilości\r\n        if int(ilosc_ml) < int(ilosc_pozostala):\r\n            cur.close()\r\n            conn.close()\r\n            return render_template(\r\n                \"edytuj_oddanie.html\",\r\n                oddanie=oddanie,\r\n                error=\"Ilość początkowa musi być większa niż ilość pozostała.\"\r\n            )\r\n\r\n        # 3. UPDATE\r\n        cur.execute(\"\"\"\r\n                    UPDATE oddania_krwi\r\n                    SET ilosc_ml = %s,\r\n                        data_oddania = %s\r\n                    WHERE id_oddania = %s;\r\n                    \"\"\", (ilosc_ml, data_oddania, id_oddania))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n        return redirect(\"/pracownik/oddania\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"edytuj_oddanie.html\", oddanie=oddanie)\r\n\r\n\r\n@app.route(\"/pracownik/oddania/usun/<int:id_oddania>\")\r\n@login_required(role=\"PRACOWNIK\")\r\ndef usun_oddanie(id_oddania):\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"DELETE FROM oddania_krwi WHERE id_oddania = %s;\", (id_oddania,))\r\n    conn.commit()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/pracownik/oddania\")\r\n\r\n@app.route(\"/pracownik/zapotrzebowania\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef zapotrzebowania():\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # -----------------------------\r\n    # 1. ZMIANA STATUSU ZAPOTRZEBOWANIA\r\n    # -----------------------------\r\n    if request.method == \"POST\" and \"id_zapotrzebowania\" in request.form:\r\n        id_zapotrzebowania = request.form[\"id_zapotrzebowania\"]\r\n        nowy_status = request.form[\"nowy_status\"]\r\n\r\n        cur.execute(\"\"\"\r\n                    UPDATE zapotrzebowania\r\n                    SET status = %s\r\n                    WHERE id_zapotrzebowania = %s;\r\n                    \"\"\", (nowy_status, id_zapotrzebowania))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n        return redirect(\"/pracownik/zapotrzebowania\")\r\n\r\n    # -----------------------------\r\n    # 2. FILTROWANIE\r\n    # -----------------------------\r\n    filter_status = request.form.get(\"filter_status\") if request.method == \"POST\" else None\r\n\r\n    base_query = \"\"\"\r\n                 SELECT *\r\n                 FROM widok_status_zapotrzebowan\r\n                 \"\"\"\r\n\r\n    if filter_status and filter_status != \"wszystkie\":\r\n        cur.execute(base_query + \" WHERE status = %s ORDER BY data_wydania DESC;\", (filter_status,))\r\n    else:\r\n        cur.execute(base_query + \" ORDER BY data_wydania DESC;\")\r\n\r\n    zapotrzebowania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"zapotrzebowania.html\",\r\n                           zapotrzebowania=zapotrzebowania,\r\n                           filter_status=filter_status)\r\n\r\n\r\n@app.route(\"/pracownik/zapotrzebowania/zrealizuj/<int:id_zapotrzebowania>\", methods=[\"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef zrealizuj_zapotrzebowanie(id_zapotrzebowania):\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    try:\r\n        # 1. Id pracownika\r\n        cur.execute(\"\"\"\r\n                    SELECT id_pracownika\r\n                    FROM pracownicy_banku\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (user_id,))\r\n        id_pracownika = cur.fetchone()[0]\r\n\r\n        # 2. Zapotrzebowanie - POBIERAMY TEŻ STATUS\r\n        cur.execute(\"\"\"\r\n                    SELECT grupa_krwi, rh, ilosc_ml, status\r\n                    FROM zapotrzebowania\r\n                    WHERE id_zapotrzebowania = %s;\r\n                    \"\"\", (id_zapotrzebowania,))\r\n        dane_zapotrzebowania = cur.fetchone()\r\n\r\n        if not dane_zapotrzebowania:\r\n            return \"Nie znaleziono zapotrzebowania\", 404\r\n\r\n        grupa, rh, ilosc_potrzebna, status = dane_zapotrzebowania\r\n\r\n        # --- ZABEZPIECZENIE 1: Sprawdź czy już nie zrealizowane ---\r\n        if status == 'zrealizowane':\r\n            cur.close()\r\n            conn.close()\r\n            flash(\"To zapotrzebowanie zostało już zrealizowane!\", \"warning\")  # <--- ZMIANA\r\n            return redirect(\"/pracownik/zapotrzebowania\")                   # <--- ZMIANA\r\n\r\n        # 3. Sprawdzenie stanu magazynowego\r\n        cur.execute(\"\"\"\r\n                    SELECT dostepne_ml\r\n                    FROM widok_stan_krwi\r\n                    WHERE grupa_krwi = %s AND rh = %s;\r\n                    \"\"\", (grupa, rh))\r\n        wynik = cur.fetchone()\r\n\r\n        if wynik is None or wynik[0] < ilosc_potrzebna:\r\n            cur.close()\r\n            conn.close()\r\n            # Tutaj wstawiamy Flash Message zamiast return string\r\n            flash(f\"Brak wystarczającej ilości krwi w magazynie! Brakuje {ilosc_potrzebna - (wynik[0] if wynik else 0)} ml.\", \"danger\") # <--- ZMIANA\r\n            return redirect(\"/pracownik/zapotrzebowania\") # <--- ZMIANA: Powrót na tę samą stronę\r\n\r\n        # 4. Pobranie oddań (FIFO)\r\n        cur.execute(\"\"\"\r\n                    SELECT id_oddania, ilosc_pozostala\r\n                    FROM widok_magazyn\r\n                    WHERE grupa_krwi = %s\r\n                      AND rh = %s\r\n                      AND status = 'dostepne'\r\n                      AND ilosc_pozostala > 0\r\n                    ORDER BY data_waznosci ASC;\r\n                    \"\"\", (grupa, rh))\r\n        oddania = cur.fetchall()\r\n\r\n        pozostalo = ilosc_potrzebna\r\n\r\n        for id_oddania, ilosc_pozostala in oddania:\r\n            if pozostalo <= 0:\r\n                break\r\n\r\n            # Oblicz ile bierzemy z tego worka\r\n            ilosc_do_pobrania = min(ilosc_pozostala, pozostalo)\r\n\r\n            # --- ZABEZPIECZENIE 2: INSERT ON CONFLICT (Dla PostgreSQL) ---\r\n            # Jeśli wpis już istnieje (np. po błędzie), aktualizujemy go zamiast wyrzucać błąd\r\n            cur.execute(\"\"\"\r\n                        INSERT INTO oddanie_zapotrzebowanie (id_oddania, id_zapotrzebowania, ilosc_ml)\r\n                        VALUES (%s, %s, %s)\r\n                            ON CONFLICT (id_oddania, id_zapotrzebowania) \r\n                        DO UPDATE SET ilosc_ml = oddanie_zapotrzebowanie.ilosc_ml + EXCLUDED.ilosc_ml;\r\n                        \"\"\", (id_oddania, id_zapotrzebowania, ilosc_do_pobrania))\r\n\r\n            # Aktualizacja magazynu (oddania)\r\n            if ilosc_pozostala <= pozostalo:\r\n                # Zużywamy całe oddanie\r\n                cur.execute(\"\"\"\r\n                            UPDATE oddania_krwi\r\n                            SET ilosc_pozostala = 0,\r\n                                status = 'zuzyte'\r\n                            WHERE id_oddania = %s;\r\n                            \"\"\", (id_oddania,))\r\n            else:\r\n                # Zużywamy część\r\n                nowa_pozostala = ilosc_pozostala - pozostalo\r\n                cur.execute(\"\"\"\r\n                            UPDATE oddania_krwi\r\n                            SET ilosc_pozostala = %s\r\n                            WHERE id_oddania = %s;\r\n                            \"\"\", (nowa_pozostala, id_oddania))\r\n\r\n            pozostalo -= ilosc_do_pobrania\r\n\r\n        if pozostalo > 0:\r\n            conn.rollback()\r\n            cur.close()\r\n            conn.close()\r\n            flash(\"Wystąpił błąd spójności danych. Operacja anulowana.\", \"danger\") # <--- ZMIANA\r\n            return redirect(\"/pracownik/zapotrzebowania\")\r\n\r\n        # 5. Aktualizacja zapotrzebowania\r\n        cur.execute(\"\"\"\r\n                    UPDATE zapotrzebowania\r\n                    SET status = 'zrealizowane',\r\n                        id_pracownika = %s,\r\n                        data_wydania = NOW()\r\n                    WHERE id_zapotrzebowania = %s;\r\n                    \"\"\", (id_pracownika, id_zapotrzebowania))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        flash(\"Pomyślnie zrealizowano zapotrzebowanie!\", \"success\") # <--- Opcjonalnie: Sukces też jako alert\r\n        return redirect(\"/pracownik/zapotrzebowania\")\r\n\r\n    except Exception as e:\r\n        conn.rollback() # Bardzo ważne: rollback przy każdym błędzie\r\n        cur.close()\r\n        conn.close()\r\n        # Wyłapujemy niespodziewane błędy i też pokazujemy jako alert\r\n        flash(f\"Wystąpił błąd systemu: {str(e)}\", \"danger\")\r\n        return redirect(\"/pracownik/zapotrzebowania\")\r\n\r\n@app.route(\"/pracownik/magazyn\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"PRACOWNIK\")\r\ndef magazyn():\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobieramy dane z formularza\r\n    grupa = request.form.get(\"grupa\")\r\n    rh = request.form.get(\"rh\")\r\n\r\n    # Obsługa pustych wartości (jeśli ktoś wybrał \"-- wszystkie --\")\r\n    if grupa == \"\":\r\n        grupa = None\r\n    if rh == \"\":\r\n        rh = None\r\n\r\n    # NAPRAWA PLUSIKA: Czasami przeglądarka wysyła \"+\" jako spację \" \"\r\n    if rh == ' ':\r\n        rh = '+'\r\n\r\n    # --- 1. KREW DOSTĘPNA (BUDOWANIE ZAPYTANIA) ---\r\n    query = \"\"\"\r\n            SELECT id_oddania, dawca, grupa_krwi, rh,\r\n                   ilosc_poczatkowa, ilosc_pozostala, status, data_waznosci\r\n            FROM widok_magazyn\r\n            WHERE status = 'dostepne'\r\n            \"\"\"\r\n    params = []\r\n\r\n    # Dynamiczne dodawanie warunków\r\n    if grupa:\r\n        query += \" AND grupa_krwi = %s\"\r\n        params.append(grupa)\r\n\r\n    if rh:\r\n        query += \" AND rh = %s\"\r\n        params.append(rh)\r\n\r\n    # Na końcu sortowanie\r\n    query += \" ORDER BY data_waznosci ASC;\"\r\n\r\n    # Wykonanie zapytania z parametrami\r\n    cur.execute(query, tuple(params))\r\n    dostepne = cur.fetchall()\r\n\r\n    # --- 2. POZOSTAŁE STATUSY (Bez zmian) ---\r\n    cur.execute(\"\"\"\r\n                SELECT id_oddania, dawca, grupa_krwi, rh,\r\n                       ilosc_poczatkowa, ilosc_pozostala, status, data_waznosci\r\n                FROM widok_magazyn\r\n                WHERE status = 'przeterminowane'\r\n                ORDER BY data_waznosci ASC;\r\n                \"\"\")\r\n    przeterminowane = cur.fetchall()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT id_oddania, dawca, grupa_krwi, rh,\r\n                       ilosc_poczatkowa, ilosc_pozostala, status, data_waznosci\r\n                FROM widok_magazyn\r\n                WHERE status = 'zuzyte'\r\n                ORDER BY data_waznosci ASC;\r\n                \"\"\")\r\n    zuzyte = cur.fetchall()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT id_oddania, dawca, grupa_krwi, rh,\r\n                       ilosc_poczatkowa, ilosc_pozostala, status, data_waznosci\r\n                FROM widok_magazyn\r\n                WHERE status = 'odrzucone_badanie'\r\n                ORDER BY data_waznosci ASC;\r\n                \"\"\")\r\n    odrzucone = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"magazyn.html\",\r\n        dostepne=dostepne,\r\n        przeterminowane=przeterminowane,\r\n        zuzyte=zuzyte,\r\n        odrzucone=odrzucone\r\n    )\r\n\r\n@app.route(\"/pracownik/powiazania\")\r\n@login_required(role=\"PRACOWNIK\")\r\ndef powiazania():\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT *\r\n                FROM widok_powiazania\r\n                ORDER BY id_zapotrzebowania DESC;\r\n                \"\"\")\r\n    powiazania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"powiazania.html\", powiazania=powiazania)\r\n\r\n\r\n\r\n\r\n@app.route(\"/szpital\")\r\n@login_required(role=\"SZPITAL\")\r\ndef panel_szpitala():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie danych szpitala\r\n    cur.execute(\"\"\"\r\n                SELECT id_szpitala, nazwa, adres\r\n                FROM szpitale\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    szpital = cur.fetchone()\r\n\r\n    if not szpital:\r\n        cur.close()\r\n        conn.close()\r\n        return \"Brak danych szpitala\", 400\r\n\r\n    id_szpitala = szpital[0]\r\n\r\n    # Pobranie statystyk zapotrzebowań\r\n    cur.execute(\"\"\"\r\n                SELECT\r\n                    COUNT(*) FILTER (WHERE status = 'oczekujace') AS oczekujace,\r\n                    COUNT(*) FILTER (WHERE status = 'zrealizowane') AS zrealizowane,\r\n                    COUNT(*) AS wszystkie\r\n                FROM zapotrzebowania\r\n                WHERE id_szpitala = %s;\r\n                \"\"\", (id_szpitala,))\r\n    statystyki = cur.fetchone()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"panel_szpitala.html\",\r\n        nazwa=szpital[1],\r\n        adres=szpital[2],\r\n        oczekujace=statystyki[0],\r\n        zrealizowane=statystyki[1],\r\n        wszystkie=statystyki[2]\r\n    )\r\n\r\n@app.route(\"/szpital/dane\")\r\n@login_required(role=\"SZPITAL\")\r\ndef dane_szpitala():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT nazwa, adres\r\n                FROM szpitale\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n\r\n    dane = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"dane_szpitala.html\",\r\n        nazwa=dane[0],\r\n        adres=dane[1],\r\n    )\r\n\r\n@app.route(\"/szpital/dane/edytuj\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"SZPITAL\")\r\ndef edytuj_dane_szpitala():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie aktualnych danych szpitala\r\n    cur.execute(\"\"\"\r\n                SELECT nazwa, adres\r\n                FROM szpitale\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    dane = cur.fetchone()\r\n\r\n    if request.method == \"POST\":\r\n        nazwa = request.form[\"nazwa\"]\r\n        adres = request.form[\"adres\"]\r\n\r\n        cur.execute(\"\"\"\r\n                    UPDATE szpitale\r\n                    SET nazwa = %s,\r\n                        adres = %s\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (nazwa, adres, user_id))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        return redirect(\"/szpital/dane\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"edytuj_dane_szpitala.html\",\r\n        nazwa=dane[0],\r\n        adres=dane[1],\r\n    )\r\n\r\n\r\n@app.route(\"/szpital/zapotrzebowania\")\r\n@login_required(role=\"SZPITAL\")\r\ndef zapotrzebowania_szpitala():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id szpitala\r\n    cur.execute(\"\"\"\r\n                SELECT id_szpitala\r\n                FROM szpitale\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_szpitala = cur.fetchone()[0]\r\n\r\n    # Pobranie zapotrzebowań tego szpitala\r\n    cur.execute(\"\"\"\r\n                SELECT id_zapotrzebowania,\r\n                       grupa_krwi,\r\n                       rh,\r\n                       ilosc_ml,\r\n                       status,\r\n                       data_wydania\r\n                FROM zapotrzebowania\r\n                WHERE id_szpitala = %s\r\n                ORDER BY data_wydania DESC;\r\n                \"\"\", (id_szpitala,))\r\n    zapotrzebowania = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"zapotrzebowania_szpitala.html\",\r\n                           zapotrzebowania=zapotrzebowania)\r\n\r\n@app.route(\"/szpital/zapotrzebowania/edytuj/<int:id_zapotrzebowania>\", methods=[\"POST\"])\r\n@login_required(role=\"SZPITAL\")\r\ndef edytuj_zapotrzebowanie_szpital(id_zapotrzebowania):\r\n    user_id = session[\"user_id\"]\r\n\r\n    grupa = request.form[\"grupa\"]\r\n    rh = request.form[\"rh\"]\r\n    ilosc_ml = request.form[\"ilosc_ml\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # upewniamy się, że zapotrzebowanie należy do tego szpitala i jest oczekujące\r\n    cur.execute(\"\"\"\r\n                UPDATE zapotrzebowania\r\n                SET grupa_krwi = %s,\r\n                    rh = %s,\r\n                    ilosc_ml = %s\r\n                WHERE id_zapotrzebowania = %s\r\n                  AND id_szpitala = (SELECT id_szpitala FROM szpitale WHERE id_uzytkownika = %s)\r\n                  AND status = 'oczekujace';\r\n                \"\"\", (grupa, rh, ilosc_ml, id_zapotrzebowania, user_id))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/szpital/zapotrzebowania\")\r\n\r\n@app.route(\"/szpital/zapotrzebowania/usun/<int:id_zapotrzebowania>\", methods=[\"POST\"])\r\n@login_required(role=\"SZPITAL\")\r\ndef usun_zapotrzebowanie_szpital(id_zapotrzebowania):\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                DELETE FROM zapotrzebowania\r\n                WHERE id_zapotrzebowania = %s\r\n                  AND id_szpitala = (SELECT id_szpitala FROM szpitale WHERE id_uzytkownika = %s)\r\n                  AND status = 'oczekujace';\r\n                \"\"\", (id_zapotrzebowania, user_id))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/szpital/zapotrzebowania\")\r\n\r\n\r\n@app.route(\"/szpital/zapotrzebowania/dodaj\", methods=[\"GET\", \"POST\"])\r\n@login_required(role=\"SZPITAL\")\r\ndef dodaj_zapotrzebowanie():\r\n    user_id = session[\"user_id\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Pobranie id szpitala\r\n    cur.execute(\"\"\"\r\n                SELECT id_szpitala\r\n                FROM szpitale\r\n                WHERE id_uzytkownika = %s;\r\n                \"\"\", (user_id,))\r\n    id_szpitala = cur.fetchone()[0]\r\n\r\n    if request.method == \"POST\":\r\n        grupa = request.form[\"grupa\"]\r\n        rh = request.form[\"rh\"]\r\n        ilosc_ml = request.form[\"ilosc_ml\"]\r\n        data_wydania = request.form[\"data_wydania\"]\r\n\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO zapotrzebowania\r\n                    (id_szpitala, grupa_krwi, rh, ilosc_ml, status, data_wydania, id_pracownika)\r\n                    VALUES (%s, %s, %s, %s, 'oczekujace', %s, NULL);\r\n                    \"\"\", (id_szpitala, grupa, rh, ilosc_ml, data_wydania))\r\n\r\n        conn.commit()\r\n        cur.close()\r\n        conn.close()\r\n\r\n        return redirect(\"/szpital/zapotrzebowania\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"dodaj_zapotrzebowanie.html\")\r\n\r\n\r\n@app.route(\"/admin\")\r\n@login_required(role=\"ADMIN\")\r\ndef panel_admina():\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # Statystyki\r\n    cur.execute(\"SELECT COUNT(*) FROM uzytkownicy;\")\r\n    uzytkownicy = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM dawcy;\")\r\n    dawcy = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM pracownicy_banku;\")\r\n    pracownicy = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM szpitale;\")\r\n    szpitale = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM oddania_krwi;\")\r\n    oddania = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM zapotrzebowania;\")\r\n    zapotrzebowania = cur.fetchone()[0]\r\n\r\n    cur.execute(\"SELECT COUNT(*) FROM badania;\")\r\n    badania = cur.fetchone()[0]\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\r\n        \"panel_admina.html\",\r\n        uzytkownicy=uzytkownicy,\r\n        dawcy=dawcy,\r\n        pracownicy=pracownicy,\r\n        szpitale=szpitale,\r\n        oddania=oddania,\r\n        zapotrzebowania=zapotrzebowania,\r\n        badania=badania\r\n    )\r\n\r\n@app.route(\"/admin/uzytkownicy\")\r\n@login_required(role=\"ADMIN\")\r\ndef admin_uzytkownicy():\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    cur.execute(\"\"\"\r\n                SELECT id_uzytkownika, login, rola, data_rejestracji\r\n                FROM uzytkownicy\r\n                ORDER BY id_uzytkownika;\r\n                \"\"\")\r\n    uzytkownicy = cur.fetchall()\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return render_template(\"admin_uzytkownicy.html\", uzytkownicy=uzytkownicy)\r\n\r\n@app.route(\"/admin/uzytkownicy/dodaj\", methods=[\"POST\"])\r\n@login_required(role=\"ADMIN\")\r\ndef admin_uzytkownicy_dodaj():\r\n    login = request.form[\"login\"]\r\n    haslo = request.form[\"haslo\"]\r\n    rola = request.form[\"rola\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    # 1. Dodajemy użytkownika\r\n    cur.execute(\"\"\"\r\n                INSERT INTO uzytkownicy (login, haslo, rola)\r\n                VALUES (%s, public.crypt(%s, public.gen_salt('bf')), %s)\r\n                    RETURNING id_uzytkownika;\r\n                \"\"\", (login, haslo, rola))\r\n\r\n    id_uzytkownika = cur.fetchone()[0]\r\n\r\n    # 2. W zależności od roli dodajemy dane do odpowiedniej tabeli\r\n\r\n    if rola == \"DAWCA\":\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika)\r\n                    VALUES (%s, %s, %s, %s, %s, %s, %s);\r\n                    \"\"\", (\r\n                        request.form[\"d_imie\"],\r\n                        request.form[\"d_nazwisko\"],\r\n                        request.form[\"d_pesel\"],\r\n                        request.form[\"d_grupa\"],\r\n                        request.form[\"d_rh\"],\r\n                        request.form[\"d_kontakt\"],\r\n                        id_uzytkownika\r\n                    ))\r\n\r\n    elif rola == \"PRACOWNIK\":\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO pracownicy_banku (imie, nazwisko, stanowisko, id_uzytkownika)\r\n                    VALUES (%s, %s, %s, %s);\r\n                    \"\"\", (\r\n                        request.form[\"p_imie\"],\r\n                        request.form[\"p_nazwisko\"],\r\n                        request.form[\"p_stanowisko\"],\r\n                        id_uzytkownika\r\n                    ))\r\n\r\n    elif rola == \"SZPITAL\":\r\n        cur.execute(\"\"\"\r\n                    INSERT INTO szpitale (nazwa, adres, id_uzytkownika)\r\n                    VALUES (%s, %s, %s);\r\n                    \"\"\", (\r\n                        request.form[\"s_nazwa\"],\r\n                        request.form[\"s_adres\"],\r\n                        id_uzytkownika\r\n                    ))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/admin/uzytkownicy\")\r\n\r\n@app.route(\"/admin/uzytkownicy/edytuj/<int:id_uzytkownika>\", methods=[\"POST\"])\r\n@login_required(role=\"ADMIN\")\r\ndef admin_uzytkownicy_edytuj(id_uzytkownika):\r\n    login = request.form[\"login\"]\r\n    haslo = request.form[\"haslo\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    if haslo.strip() == \"\":\r\n        # zmiana tylko loginu\r\n        cur.execute(\"\"\"\r\n                    UPDATE uzytkownicy\r\n                    SET login = %s\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (login, id_uzytkownika))\r\n    else:\r\n        # zmiana loginu i hasła\r\n        cur.execute(\"\"\"\r\n                    UPDATE uzytkownicy\r\n                    SET login = %s,\r\n                        haslo = public.crypt(%s, gen_salt('bf'))\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (login, haslo, id_uzytkownika))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    return redirect(\"/admin/uzytkownicy\")\r\n\r\n\r\n@app.route(\"/admin/uzytkownicy/usun/<int:id_uzytkownika>\", methods=[\"POST\"])\r\n@login_required(role=\"ADMIN\")\r\ndef admin_uzytkownicy_usun(id_uzytkownika):\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n    cur.execute(\"DELETE FROM uzytkownicy WHERE id_uzytkownika = %s;\", (id_uzytkownika,))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n    return redirect(\"/admin/uzytkownicy\")\r\n\r\n@app.route(\"/uzytkownik/edytuj\", methods=[\"POST\"])\r\n@login_required()\r\ndef edytuj_uzytkownika():\r\n    user_id = session[\"user_id\"]\r\n    login = request.form[\"login\"]\r\n    haslo = request.form[\"haslo\"]\r\n\r\n    conn = get_db()\r\n    cur = conn.cursor()\r\n\r\n    if haslo.strip() == \"\":\r\n        cur.execute(\"\"\"\r\n                    UPDATE uzytkownicy\r\n                    SET login = %s\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (login, user_id))\r\n    else:\r\n        cur.execute(\"\"\"\r\n                    UPDATE uzytkownicy\r\n                    SET login = %s,\r\n                        haslo = crypt(%s, gen_salt('bf'))\r\n                    WHERE id_uzytkownika = %s;\r\n                    \"\"\", (login, haslo, user_id))\r\n\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    session[\"login\"] = login\r\n\r\n    # wracamy do panelu zależnie od roli\r\n    rola = session[\"rola\"]\r\n    if rola == \"DAWCA\":\r\n        return redirect(\"/dawca\")\r\n    if rola == \"PRACOWNIK\":\r\n        return redirect(\"/pracownik\")\r\n    if rola == \"SZPITAL\":\r\n        return redirect(\"/szpital\")\r\n    if rola == \"ADMIN\":\r\n        return redirect(\"/admin\")\r\n\r\n\r\n    return render_template(\"dane_konta.html\", uzytkownicy=uzytkownicy)\r\n@app.route(\"/logout\")\r\ndef logout():\r\n    session.clear()\r\n    return render_template(\"logout.html\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    app.run(debug=False)
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/Bank_krwi/app.py b/Bank_krwi/app.py
--- a/Bank_krwi/app.py	(revision a05326d4c698d9c3abb0bc07c5796039845a2e9c)
+++ b/Bank_krwi/app.py	(date 1768606464454)
@@ -77,31 +77,41 @@
         conn = get_db()
         cur = conn.cursor()
 
-        #dodanie użytkownika
-        cur.execute("""
-                    INSERT INTO uzytkownicy (login, haslo, rola, data_rejestracji)
-                    VALUES (%s, public.crypt(%s, public.gen_salt('bf')), 'DAWCA', CURRENT_DATE)
-                        RETURNING id_uzytkownika;
-                    """, (login, haslo))
+        #sprawdzam czy login jest zajety
+        cur.execute("SELECT id_uzytkownika FROM uzytkownicy WHERE login = %s",(login,))
+        istniejacy_uzytkownik = cur.fetchone()
+
+        if istniejacy_uzytkownik:
+            error = "Ten login jest już zajęty. Wybierz inny."
+        else:
+            #dodanie użytkownika
+            cur.execute("""
+                        INSERT INTO uzytkownicy (login, haslo, rola, data_rejestracji)
+                        VALUES (%s, public.crypt(%s, public.gen_salt('bf')), 'DAWCA', CURRENT_DATE)
+                            RETURNING id_uzytkownika;
+                        """, (login, haslo))
 
-        id_uzytkownika = cur.fetchone()[0]
+            id_uzytkownika = cur.fetchone()[0]
 
-        #dodanie dawcy
-        cur.execute("""
-                    INSERT INTO dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika)
-                    VALUES (%s, %s, %s, %s, %s, %s, %s);
-                    """, (imie, nazwisko, pesel, grupa, rh, kontakt, id_uzytkownika))
+            #dodanie dawcy
+            cur.execute("""
+                        INSERT INTO dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika)
+                        VALUES (%s, %s, %s, %s, %s, %s, %s);
+                        """, (imie, nazwisko, pesel, grupa, rh, kontakt, id_uzytkownika))
 
-        conn.commit()
-        cur.close()
-        conn.close()
-
-        #automatyczne logowanie po rejestracji
-        session["user_id"] = id_uzytkownika
-        session["rola"] = "DAWCA"
+            #automatyczne logowanie po rejestracji
+            session["user_id"] = id_uzytkownika
+            session["rola"] = "DAWCA"
 
-        return redirect("/welcome")
+            conn.commit()
+            cur.close()
+            conn.close()
+
+            return redirect("/welcome")
 
+        cur.close()
+        conn.close()
+
     return render_template("register.html", error=error)
 
 
Index: sql/bank_krwi.sql
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>-- włącz rozszerzenie pgcrypto\r\ncreate extension if not exists pgcrypto;\r\n\r\n-- utworzenie schematu\r\ncreate schema if not exists bank_krwi;\r\nset search_path to bank_krwi, public;\r\n\r\n-- tabele główne\r\ncreate table Uzytkownicy (\r\n    id_uzytkownika serial primary key,\r\n    login varchar(50) not null unique,\r\n    haslo varchar(200) not null,\r\n    rola varchar(20) check (rola in ('ADMIN','PRACOWNIK','SZPITAL','DAWCA')),\r\n    data_rejestracji date default current_date\r\n);\r\n\r\ncreate table Dawcy (\r\n    id_dawcy serial primary key,\r\n    imie varchar(30) not null,\r\n    nazwisko varchar(30) not null,\r\n    pesel varchar(11) unique not null,\r\n    grupa_krwi varchar(2) check (grupa_krwi in ('A','B','AB','0')),\r\n    rh varchar(1) check (rh in ('+','-')),\r\n    kontakt varchar(9),\r\n    id_uzytkownika int unique references Uzytkownicy(id_uzytkownika),\r\n    cel_ml int\r\n);\r\n\r\ncreate table Pracownicy_banku (\r\n    id_pracownika serial primary key,\r\n    imie varchar(30) not null,\r\n    nazwisko varchar(30) not null,\r\n    stanowisko varchar(20) check (stanowisko in ('lekarz','laborant')),\r\n    id_uzytkownika int unique references Uzytkownicy(id_uzytkownika)\r\n);\r\n\r\ncreate table Szpitale (\r\n    id_szpitala serial primary key,\r\n    nazwa varchar(100) not null,\r\n    adres varchar(200),\r\n    id_uzytkownika int unique references Uzytkownicy(id_uzytkownika)\r\n);\r\n\r\ncreate table Zgloszenia (\r\n    id_zgloszenia serial primary key,\r\n    id_dawcy int references Dawcy(id_dawcy),\r\n    data_zgloszenia date default current_date,\r\n    status varchar(20) check (status in ('oczekujace','zaakceptowane'))\r\n);\r\n\r\ncreate table Oddania_krwi (\r\n    id_oddania serial primary key,\r\n    data_oddania date not null,\r\n    ilosc_ml int check (ilosc_ml between 200 and 500),\r\n    data_waznosci date,\r\n    id_dawcy int references Dawcy(id_dawcy),\r\n    id_zgloszenia int references Zgloszenia(id_zgloszenia),\r\n    id_pracownika int references Pracownicy_banku(id_pracownika),\r\n    ilosc_pozostala int default 0,\r\n    status varchar(20) default 'dostepne' check (status in('dostepne','zuzyte','przeterminowane','odrzucone_badanie'))\r\n);\r\n\r\ncreate table Zapotrzebowania (\r\n    id_zapotrzebowania serial primary key,\r\n    id_szpitala int references Szpitale(id_szpitala),\r\n    grupa_krwi varchar(2) check (grupa_krwi in ('A','B','AB','0')),\r\n    rh varchar(1) check (rh in ('+','-')),\r\n    ilosc_ml int check (ilosc_ml > 0),\r\n    status varchar(20) check (status in ('oczekujace','zrealizowane')),\r\n    data_wydania date,\r\n    id_pracownika int references Pracownicy_banku(id_pracownika)\r\n);\r\n\r\ncreate table Badania (\r\n    id_badania serial primary key,\r\n    id_oddania int references Oddania_krwi(id_oddania),\r\n    rodzaj_badania varchar(50) not null,\r\n    wynik varchar(50) check (wynik in('pozytywny', 'negatywny'),\r\n    data_badania date,\r\n    id_pracownika int references Pracownicy_banku(id_pracownika)\r\n);\r\n\r\n\r\n-- tabele asocjacyjne (n-m)\r\ncreate table Oddanie_Zapotrzebowanie (\r\n    id_oddania int references Oddania_krwi(id_oddania),\r\n    id_zapotrzebowania int references Zapotrzebowania(id_zapotrzebowania),\r\n    ilosc_ml int check (ilosc_ml > 0),\r\n    primary key (id_oddania, id_zapotrzebowania)\r\n);\r\n\r\ncreate table Dawca_Szpital (\r\n    id_dawcy int references Dawcy(id_dawcy),\r\n    id_szpitala int references Szpitale(id_szpitala),\r\n    id_oddania int references Oddania_krwi(id_oddania),\r\n    data_przekazania date,\r\n    primary key (id_dawcy, id_szpitala, id_oddania)\r\n);\r\n\r\n\r\n--dodawanie danych\r\n-- Uzytkownicy\r\ninsert into Uzytkownicy (login, haslo, rola) values\r\n('admin1', crypt('adminpass', gen_salt('bf')), 'ADMIN'),\r\n('pracownik1', crypt('pracpass', gen_salt('bf')), 'PRACOWNIK'),\r\n('pracownik2', crypt('pracpass2', gen_salt('bf')), 'PRACOWNIK'),\r\n('szpital1', crypt('szpitpass', gen_salt('bf')), 'SZPITAL'),\r\n('dawca1', crypt('dawcapass', gen_salt('bf')), 'DAWCA'),\r\n('dawca2', crypt('dawcapass2', gen_salt('bf')), 'DAWCA');\r\n\r\nINSERT INTO Uzytkownicy (login, haslo, rola)\r\nVALUES ('admin2', crypt('admin123', gen_salt('bf')), 'ADMIN');\r\n\r\n-- Dawcy (wiążemy po loginie, nie po \"zgadywanym\" ID)\r\ninsert into Dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika) values\r\n('Jan',  'Kowalski', '90010112345', 'A',  '+', '123456789',\r\n (select id_uzytkownika from Uzytkownicy where login='dawca1')),\r\n('Anna', 'Nowak',    '92050567890', '0',  '-', '987654321',\r\n (select id_uzytkownika from Uzytkownicy where login='dawca2'));\r\n\r\n-- Pracownicy_banku\r\ninsert into Pracownicy_banku (imie, nazwisko, stanowisko, id_uzytkownika) values\r\n('Piotr', 'Lekarz',   'lekarz',   (select id_uzytkownika from Uzytkownicy where login='pracownik1')),\r\n('Maria', 'Laborant', 'laborant', (select id_uzytkownika from Uzytkownicy where login='pracownik2'));\r\n\r\n-- Szpitale\r\ninsert into Szpitale (nazwa, adres, id_uzytkownika) values\r\n('Szpital Uniwersytecki', 'Kraków, ul. Kopernika 36', (select id_uzytkownika from Uzytkownicy where login='szpital1'));\r\n\r\n-- Zgloszenia (po peselu dawcy)\r\nwith d as (\r\n  select id_dawcy from Dawcy where pesel in ('90010112345','92050567890')\r\n)\r\ninsert into Zgloszenia (id_dawcy, data_zgloszenia, status) values\r\n((select id_dawcy from Dawcy where pesel='90010112345'), '2025-12-01', 'zaakceptowane'),\r\n((select id_dawcy from Dawcy where pesel='92050567890'), '2025-12-02', 'oczekujace');\r\n\r\n-- Oddania_krwi (trigger uzupełni grupa_krwi i rh; nie podajemy ich ręcznie)\r\ninsert into Oddania_krwi (data_oddania, ilosc_ml, data_waznosci, id_dawcy, id_zgloszenia, id_pracownika) values\r\n('2025-12-03', 450, '2026-01-14',\r\n (select id_dawcy from Dawcy where pesel='90010112345'),\r\n (select id_zgloszenia from Zgloszenia where id_dawcy = (select id_dawcy from Dawcy where pesel='90010112345')),\r\n (select id_pracownika from Pracownicy_banku where id_uzytkownika = (select id_uzytkownika from Uzytkownicy where login='pracownik1'))),\r\n('2025-12-04', 500, '2026-01-15',\r\n (select id_dawcy from Dawcy where pesel='92050567890'),\r\n (select id_zgloszenia from Zgloszenia where id_dawcy = (select id_dawcy from Dawcy where pesel='92050567890')),\r\n (select id_pracownika from Pracownicy_banku where id_uzytkownika = (select id_uzytkownika from Uzytkownicy where login='pracownik1')));\r\n\r\n-- Badania (po ostatnim oddaniu i pracowniku)\r\ninsert into Badania (id_oddania, rodzaj_badania, wynik, data_badania, id_pracownika) values\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='90010112345') order by id_oddania limit 1),\r\n 'HIV', 'negatywny', '2025-12-05',\r\n (select id_pracownika from Pracownicy_banku where id_uzytkownika = (select id_uzytkownika from Uzytkownicy where login='pracownik2'))),\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='90010112345') order by id_oddania limit 1),\r\n 'HBV', 'negatywny', '2025-12-05',\r\n (select id_pracownika from Pracownicy_banku where id_uzytkownika = (select id_uzytkownika from Uzytkownicy where login='pracownik2'))),\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='92050567890') order by id_oddania limit 1),\r\n 'HCV', 'negatywny', '2025-12-06',\r\n (select id_pracownika from Pracownicy_banku where id_uzytkownika = (select id_uzytkownika from Uzytkownicy where login='pracownik2')));\r\n\r\n-- Zapotrzebowania\r\ninsert into Zapotrzebowania (id_szpitala, grupa_krwi, rh, ilosc_ml, status) values\r\n((select id_szpitala from Szpitale where nazwa='Szpital Uniwersytecki'), 'A', '+', 300, 'oczekujace'),\r\n((select id_szpitala from Szpitale where nazwa='Szpital Uniwersytecki'), '0', '-', 500, 'zrealizowane');\r\n\r\n-- Oddanie_Zapotrzebowanie (łączymy po grupie/rh i ostatnich ID)\r\ninsert into Oddanie_Zapotrzebowanie (id_oddania, id_zapotrzebowania, ilosc_ml) values\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='90010112345') order by id_oddania limit 1),\r\n (select id_zapotrzebowania from Zapotrzebowania where grupa_krwi='A' and rh='+'),\r\n 300),\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='92050567890') order by id_oddania limit 1),\r\n (select id_zapotrzebowania from Zapotrzebowania where grupa_krwi='0' and rh='-'),\r\n 500);\r\n\r\n-- Dawca_Szpital\r\ninsert into Dawca_Szpital (id_dawcy, id_szpitala, id_oddania, data_przekazania) values\r\n((select id_dawcy from Dawcy where pesel='90010112345'),\r\n (select id_szpitala from Szpitale where nazwa='Szpital Uniwersytecki'),\r\n (select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='90010112345') order by id_oddania limit 1),\r\n '2025-12-07'),\r\n((select id_dawcy from Dawcy where pesel='92050567890'),\r\n (select id_szpitala from Szpitale where nazwa='Szpital Uniwersytecki'),\r\n (select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='92050567890') order by id_oddania limit 1),\r\n '2025-12-08');\r\n\r\n--wazne\r\nUPDATE oddania_krwi\r\nSET ilosc_pozostala = ilosc_ml;\r\n\r\n\r\n--widoki\r\nCREATE OR REPLACE VIEW widok_magazyn AS\r\nSELECT\r\n    o.id_oddania,\r\n    d.imie || ' ' || d.nazwisko AS dawca,\r\n    d.grupa_krwi,\r\n    d.rh,\r\n    o.ilosc_ml AS ilosc_poczatkowa,\r\n    o.ilosc_pozostala,\r\n    o.status,\r\n    o.data_waznosci\r\nFROM oddania_krwi o\r\nJOIN dawcy d ON o.id_dawcy = d.id_dawcy;\r\n\r\n\r\ncreate view Widok_status_zapotrzebowan as\r\nselect z.id_zapotrzebowania,\r\n       s.nazwa as szpital,\r\n       z.grupa_krwi,\r\n       z.rh,\r\n       z.ilosc_ml,\r\n       z.status,\r\n       z.data_wydania,\r\n       p.imie || ' ' || p.nazwisko as pracownik\r\nfrom Zapotrzebowania z\r\njoin Szpitale s on z.id_szpitala = s.id_szpitala\r\nleft join Pracownicy_banku p on z.id_pracownika = p.id_pracownika;\r\n\r\nCREATE OR REPLACE VIEW widok_historia_badania AS\r\nSELECT \r\n    b.id_badania,\r\n    o.id_oddania,\r\n    d.imie || ' ' || d.nazwisko AS dawca,\r\n    b.rodzaj_badania,\r\n    b.wynik,\r\n    b.data_badania,\r\n    p.imie || ' ' || p.nazwisko AS pracownik,\r\n    p.id_pracownika\r\nFROM Badania b\r\nJOIN Oddania_krwi o ON b.id_oddania = o.id_oddania\r\nJOIN Dawcy d ON o.id_dawcy = d.id_dawcy\r\nJOIN Pracownicy_banku p ON b.id_pracownika = p.id_pracownika;\r\n\r\ncreate view Widok_dawcy_szpitale as\r\nSELECT \r\n    ds.id_dawcy,\r\n    d.imie || ' ' || d.nazwisko AS dawca,\r\n    s.nazwa AS szpital,\r\n    ds.data_przekazania,\r\n    o.ilosc_ml AS ilosc_oddana\r\nFROM dawca_szpital ds\r\nJOIN dawcy d ON ds.id_dawcy = d.id_dawcy\r\nJOIN szpitale s ON ds.id_szpitala = s.id_szpitala\r\nJOIN oddania_krwi o ON ds.id_oddania = o.id_oddania;\r\n\r\ncreate view Widok_pracownicy_aktywnosc as\r\nselect p.id_pracownika,\r\n       p.imie || ' ' || p.nazwisko as pracownik,\r\n       p.stanowisko,\r\n       count(distinct o.id_oddania) as liczba_oddan,\r\n       count(distinct b.id_badania) as liczba_badan,\r\n       count(distinct z.id_zapotrzebowania) as liczba_zapotrzebowan\r\nfrom Pracownicy_banku p\r\nleft join Oddania_krwi o on p.id_pracownika = o.id_pracownika\r\nleft join Badania b on p.id_pracownika = b.id_pracownika\r\nleft join Zapotrzebowania z on p.id_pracownika = z.id_pracownika\r\ngroup by p.id_pracownika, p.imie, p.nazwisko, p.stanowisko;\r\n\r\ncreate view Widok_zapotrzebowania_duze as\r\nselect s.nazwa as szpital,\r\n       z.grupa_krwi,\r\n       z.rh,\r\n       sum(z.ilosc_ml) as suma_ml\r\nfrom Zapotrzebowania z\r\njoin Szpitale s on z.id_szpitala = s.id_szpitala\r\ngroup by s.nazwa, z.grupa_krwi, z.rh\r\nhaving sum(z.ilosc_ml) > 1000;\r\n\r\nCREATE OR REPLACE VIEW widok_srednia_ilosc AS\r\nSELECT ROUND(AVG(o.ilosc_ml), 2) AS srednia_ml\r\nFROM oddania_krwi o;\r\n\r\ncreate view Widok_dat_oddan as\r\nselect id_dawcy, \r\n\t\tmin(data_oddania) as pierwsze_oddanie,\r\n       max(data_oddania) as ostatnie_oddanie\r\nfrom Oddania_krwi\r\ngroup by 1;\r\n\r\ncreate view Widok_statystyki_badan as\r\nselect \r\n    count(*) filter (where wynik = 'negatywny') as negatywne,\r\n    count(*) filter (where wynik = 'pozytywny') as pozytywne\r\nfrom Badania;\r\n\r\nCREATE OR REPLACE VIEW widok_stan_krwi AS\r\nSELECT\r\n    d.grupa_krwi,\r\n    d.rh,\r\n    SUM(o.ilosc_pozostala) AS dostepne_ml\r\nFROM oddania_krwi o\r\nJOIN dawcy d ON o.id_dawcy = d.id_dawcy\r\nWHERE o.status = 'dostepne'\r\n  AND o.ilosc_pozostala > 0\r\nGROUP BY d.grupa_krwi, d.rh;\r\n\r\n\r\nCREATE VIEW widok_suma_ml AS\r\nSELECT \r\n    id_dawcy,\r\n    SUM(ilosc_ml) AS suma_ml\r\nFROM oddania_krwi\r\nGROUP BY id_dawcy;\r\n\r\nCREATE OR REPLACE VIEW widok_powiazania AS\r\nSELECT \r\n    oz.id_oddania,\r\n    o.data_oddania,\r\n    o.ilosc_ml AS ilosc_oddana,\r\n    oz.ilosc_ml AS ilosc_przekazana,\r\n    oz.id_zapotrzebowania,\r\n    z.data_wydania AS data_zapotrzebowania,\r\n    s.nazwa AS szpital\r\nFROM oddanie_zapotrzebowanie oz\r\nJOIN oddania_krwi o ON oz.id_oddania = o.id_oddania\r\nJOIN zapotrzebowania z ON oz.id_zapotrzebowania = z.id_zapotrzebowania\r\nJOIN szpitale s ON z.id_szpitala = s.id_szpitala\r\nORDER BY oz.id_zapotrzebowania DESC;\r\n\r\n\r\n--triggery\r\ncreate or replace function set_data_wydania()\r\nreturns trigger as $$\r\nbegin\r\n    if NEW.status = 'zrealizowane' and NEW.data_wydania is null then\r\n        NEW.data_wydania := current_date;\r\n    end if;\r\n    return NEW;\r\nend;\r\n$$ language plpgsql;\r\n\r\ncreate trigger trg_set_data_wydania\r\nbefore insert or update on Zapotrzebowania\r\nfor each row\r\nexecute function set_data_wydania();\r\n\r\nCREATE OR REPLACE FUNCTION ustaw_date_waznosci()\r\nRETURNS trigger AS $$\r\nBEGIN\r\n    -- ZAWSZE ustawiamy datę ważności na 35 dni od daty oddania\r\n    NEW.data_waznosci := NEW.data_oddania + INTERVAL '35 days';\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nDROP TRIGGER IF EXISTS trg_oddania_data_waznosci ON oddania_krwi;\r\n\r\nCREATE TRIGGER trg_oddania_data_waznosci\r\nBEFORE INSERT OR UPDATE ON oddania_krwi\r\nFOR EACH ROW\r\nEXECUTE FUNCTION ustaw_date_waznosci();\r\n\r\nCREATE OR REPLACE FUNCTION oznacz_przeterminowane()\r\nRETURNS trigger AS $$\r\nBEGIN\r\n    IF NEW.data_waznosci < CURRENT_DATE THEN\r\n        NEW.status := 'przeterminowane';\r\n    END IF;\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER trg_przeterminowane\r\nBEFORE UPDATE OR INSERT ON oddania_krwi\r\nFOR EACH ROW\r\nEXECUTE FUNCTION oznacz_przeterminowane();\r\n\r\nCREATE OR REPLACE FUNCTION oznacz_odrzucone_badanie()\r\nRETURNS trigger AS $$\r\nBEGIN\r\n    -- Jeśli wynik badania jest pozytywny → odrzucamy jednostkę\r\n    IF NEW.wynik = 'pozytywny' THEN\r\n        UPDATE oddania_krwi\r\n        SET status = 'odrzucone_badanie'\r\n        WHERE id_oddania = NEW.id_oddania;\r\n    END IF;\r\n\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER trg_odrzucone_badanie\r\nAFTER INSERT OR UPDATE ON badania\r\nFOR EACH ROW\r\nEXECUTE FUNCTION oznacz_odrzucone_badanie();\r\n\r\nCREATE OR REPLACE FUNCTION przyjmij_najstarsze_zgloszenie()\r\nRETURNS trigger AS $$\r\nBEGIN\r\n    -- Aktualizujemy najstarsze oczekujące zgłoszenie danego dawcy\r\n    UPDATE zgloszenia\r\n    SET status = 'zaakceptowane'\r\n    WHERE id_zgloszenia = (\r\n        SELECT id_zgloszenia\r\n        FROM zgloszenia\r\n        WHERE id_dawcy = NEW.id_dawcy\r\n          AND status = 'oczekujace'\r\n        ORDER BY data_zgloszenia ASC\r\n        LIMIT 1\r\n    );\r\n\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER trg_przyjmij_zgloszenie\r\nAFTER INSERT ON oddania_krwi\r\nFOR EACH ROW\r\nEXECUTE FUNCTION przyjmij_najstarsze_zgloszenie();\r\n\r\nCREATE OR REPLACE FUNCTION blokuj_wiele_zgloszen()\r\nRETURNS trigger AS $$\r\nBEGIN\r\n    IF EXISTS (\r\n        SELECT 1 FROM zgloszenia\r\n        WHERE id_dawcy = NEW.id_dawcy\r\n          AND status = 'oczekujace'\r\n    ) THEN\r\n        RAISE EXCEPTION 'Dawca ma już aktywne zgłoszenie.';\r\n    END IF;\r\n\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER trg_1_blokuj_wiele_zgloszen\r\nBEFORE INSERT ON zgloszenia\r\nFOR EACH ROW\r\nEXECUTE FUNCTION blokuj_wiele_zgloszen();\r\n\r\nCREATE OR REPLACE FUNCTION blokuj_wczesne_zgloszenie()\r\nRETURNS trigger AS $$\r\nDECLARE\r\n    ostatnie DATE;\r\nBEGIN\r\n    SELECT data_oddania INTO ostatnie\r\n    FROM oddania_krwi\r\n    WHERE id_dawcy = NEW.id_dawcy\r\n    ORDER BY data_oddania DESC\r\n    LIMIT 1;\r\n\r\n    IF ostatnie IS NOT NULL AND NEW.data_zgloszenia < ostatnie + INTERVAL '56 days' THEN\r\n        RAISE EXCEPTION 'Możesz oddać krew dopiero po %', ostatnie + INTERVAL '56 days';\r\n    END IF;\r\n\r\n    RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\nCREATE TRIGGER trg_2_blokuj_wczesne_zgloszenie\r\nBEFORE INSERT ON zgloszenia\r\nFOR EACH ROW\r\nEXECUTE FUNCTION blokuj_wczesne_zgloszenie();\r\n\r\n-- ==========================================\r\n-- DODATKOWE DANE TESTOWE (ROZSZERZENIE)\r\n-- ==========================================\r\n\r\n-- 1. Nowi Użytkownicy (3 dawców, 1 szpital, 1 pracownik)\r\ninsert into Uzytkownicy (login, haslo, rola) values\r\n('dawca3',    crypt('dawcapass3', gen_salt('bf')), 'DAWCA'),   -- B Rh+\r\n('dawca4',    crypt('dawcapass4', gen_salt('bf')), 'DAWCA'),   -- AB Rh- (rzadka)\r\n('dawca5',    crypt('dawcapass5', gen_salt('bf')), 'DAWCA'),   -- 0 Rh+ (zakażony - test triggera)\r\n('szpital2',  crypt('szpitpass2', gen_salt('bf')), 'SZPITAL'), -- Szpital Żeromskiego\r\n('pracownik3',crypt('pracpass3',  gen_salt('bf')), 'PRACOWNIK'); -- Nowy laborant\r\n\r\n-- 2. Profile Dawców\r\ninsert into Dawcy (imie, nazwisko, pesel, grupa_krwi, rh, kontakt, id_uzytkownika) values\r\n('Tomasz', 'Zieliński', '85021411223', 'B',  '+', '500600700',\r\n (select id_uzytkownika from Uzytkownicy where login='dawca3')),\r\n('Ewa',    'Wiśniewska','99032055443', 'AB', '-', '600700800',\r\n (select id_uzytkownika from Uzytkownicy where login='dawca4')),\r\n('Kamil',  'Chory',     '95111122334', '0',  '+', '700800900',\r\n (select id_uzytkownika from Uzytkownicy where login='dawca5'));\r\n\r\n-- 3. Profil Szpitala i Pracownika\r\ninsert into Szpitale (nazwa, adres, id_uzytkownika) values\r\n('Szpital Specjalistyczny im. S. Żeromskiego', 'Kraków, os. Na Skarpie 66',\r\n (select id_uzytkownika from Uzytkownicy where login='szpital2'));\r\n\r\ninsert into Pracownicy_banku (imie, nazwisko, stanowisko, id_uzytkownika) values\r\n('Adam', 'Nowy', 'laborant',\r\n (select id_uzytkownika from Uzytkownicy where login='pracownik3'));\r\n\r\n\r\n-- 4. Zgłoszenia\r\ninsert into Zgloszenia (id_dawcy, data_zgloszenia, status) values\r\n((select id_dawcy from Dawcy where pesel='85021411223'), '2025-12-08', 'zaakceptowane'), -- Tomasz\r\n((select id_dawcy from Dawcy where pesel='99032055443'), '2025-12-09', 'zaakceptowane'), -- Ewa\r\n((select id_dawcy from Dawcy where pesel='95111122334'), '2025-12-10', 'zaakceptowane'); -- Kamil\r\n\r\n\r\n-- 5. Oddania Krwi\r\n-- Tomasz (B+) oddał krew\r\ninsert into Oddania_krwi (data_oddania, ilosc_ml, id_dawcy, id_zgloszenia, id_pracownika) values\r\n('2025-12-09', 450,\r\n (select id_dawcy from Dawcy where pesel='85021411223'),\r\n (select id_zgloszenia from Zgloszenia where id_dawcy = (select id_dawcy from Dawcy where pesel='85021411223') limit 1),\r\n (select id_pracownika from Pracownicy_banku where nazwisko='Lekarz'));\r\n\r\n-- Ewa (AB-) oddała krew (rzadka grupa)\r\ninsert into Oddania_krwi (data_oddania, ilosc_ml, id_dawcy, id_zgloszenia, id_pracownika) values\r\n('2025-12-10', 450,\r\n (select id_dawcy from Dawcy where pesel='99032055443'),\r\n (select id_zgloszenia from Zgloszenia where id_dawcy = (select id_dawcy from Dawcy where pesel='99032055443') limit 1),\r\n (select id_pracownika from Pracownicy_banku where nazwisko='Lekarz'));\r\n\r\n-- Kamil (0+) oddał krew (będzie oznaczona jako zakażona po badaniu)\r\ninsert into Oddania_krwi (data_oddania, ilosc_ml, id_dawcy, id_zgloszenia, id_pracownika) values\r\n('2025-12-11', 450,\r\n (select id_dawcy from Dawcy where pesel='95111122334'),\r\n (select id_zgloszenia from Zgloszenia where id_dawcy = (select id_dawcy from Dawcy where pesel='95111122334') limit 1),\r\n (select id_pracownika from Pracownicy_banku where nazwisko='Lekarz'));\r\n\r\n\r\n-- 6. Badania\r\n-- Badanie Kamila wychodzi POZYTYWNE (HCV) -> Trigger powinien zmienić status oddania na 'odrzucone_badanie'\r\ninsert into Badania (id_oddania, rodzaj_badania, wynik, data_badania, id_pracownika) values\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='95111122334') order by id_oddania desc limit 1),\r\n 'HCV', 'pozytywny', '2025-12-12', -- !!! UWAGA: Pozytywny wynik\r\n (select id_pracownika from Pracownicy_banku where nazwisko='Nowy'));\r\n\r\n-- Badanie Tomasza (negatywne - OK)\r\ninsert into Badania (id_oddania, rodzaj_badania, wynik, data_badania, id_pracownika) values\r\n((select id_oddania from Oddania_krwi where id_dawcy = (select id_dawcy from Dawcy where pesel='85021411223') order by id_oddania desc limit 1),\r\n 'HIV', 'negatywny', '2025-12-10',\r\n (select id_pracownika from Pracownicy_banku where nazwisko='Laborant'));\r\n\r\n\r\n-- 7. Zapotrzebowania (Nowy szpital potrzebuje krwi B+)\r\ninsert into Zapotrzebowania (id_szpitala, grupa_krwi, rh, ilosc_ml, status) values\r\n((select id_szpitala from Szpitale where nazwa like '%Żeromskiego%'), 'B', '+', 400, 'oczekujace');\r\n\r\n-- 8. Aktualizacja ilości\r\n-- Musimy upewnić się, że nowe oddania mają ilosc_pozostala\r\nUPDATE oddania_krwi\r\nSET ilosc_pozostala = ilosc_ml\r\nWHERE ilosc_pozostala = 0 AND status = 'dostepne';\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/sql/bank_krwi.sql b/sql/bank_krwi.sql
--- a/sql/bank_krwi.sql	(revision a05326d4c698d9c3abb0bc07c5796039845a2e9c)
+++ b/sql/bank_krwi.sql	(date 1768606729935)
@@ -45,7 +45,7 @@
     id_zgloszenia serial primary key,
     id_dawcy int references Dawcy(id_dawcy),
     data_zgloszenia date default current_date,
-    status varchar(20) check (status in ('oczekujace','zaakceptowane'))
+    status varchar(20) check (status in ('oczekujace','zrealizowane'))
 );
 
 create table Oddania_krwi (
@@ -75,7 +75,7 @@
     id_badania serial primary key,
     id_oddania int references Oddania_krwi(id_oddania),
     rodzaj_badania varchar(50) not null,
-    wynik varchar(50) check (wynik in('pozytywny', 'negatywny'),
+    wynik varchar(50) check (wynik in('pozytywny', 'negatywny')),
     data_badania date,
     id_pracownika int references Pracownicy_banku(id_pracownika)
 );
@@ -132,7 +132,7 @@
   select id_dawcy from Dawcy where pesel in ('90010112345','92050567890')
 )
 insert into Zgloszenia (id_dawcy, data_zgloszenia, status) values
-((select id_dawcy from Dawcy where pesel='90010112345'), '2025-12-01', 'zaakceptowane'),
+((select id_dawcy from Dawcy where pesel='90010112345'), '2025-12-01', 'zrealizowane'),
 ((select id_dawcy from Dawcy where pesel='92050567890'), '2025-12-02', 'oczekujace');
 
 -- Oddania_krwi (trigger uzupełni grupa_krwi i rh; nie podajemy ich ręcznie)
@@ -389,7 +389,7 @@
 BEGIN
     -- Aktualizujemy najstarsze oczekujące zgłoszenie danego dawcy
     UPDATE zgloszenia
-    SET status = 'zaakceptowane'
+    SET status = 'zrealizowane'
     WHERE id_zgloszenia = (
         SELECT id_zgloszenia
         FROM zgloszenia
@@ -452,6 +452,38 @@
 FOR EACH ROW
 EXECUTE FUNCTION blokuj_wczesne_zgloszenie();
 
+-- 1. Funkcja, która znajdzie ID dawcy i ID szpitala, a potem wpisze je do tabeli historii
+CREATE OR REPLACE FUNCTION automatyczny_dawca_szpital()
+RETURNS trigger AS $$
+DECLARE
+    v_id_dawcy INT;
+    v_id_szpitala INT;
+BEGIN
+    -- Pobieramy ID dawcy na podstawie oddania
+    SELECT id_dawcy INTO v_id_dawcy 
+    FROM oddania_krwi 
+    WHERE id_oddania = NEW.id_oddania;
+
+    -- Pobieramy ID szpitala na podstawie zapotrzebowania
+    SELECT id_szpitala INTO v_id_szpitala 
+    FROM zapotrzebowania 
+    WHERE id_zapotrzebowania = NEW.id_zapotrzebowania;
+
+    -- Wstawiamy rekord do tabeli Dawca_Szpital
+    -- (Używamy ON CONFLICT DO NOTHING, żeby nie wywaliło błędu, jak już coś tam jest)
+    INSERT INTO Dawca_Szpital (id_dawcy, id_szpitala, id_oddania, data_przekazania)
+    VALUES (v_id_dawcy, v_id_szpitala, NEW.id_oddania, CURRENT_DATE)
+    ON CONFLICT DO NOTHING;
+
+    RETURN NEW;
+END;
+$$ LANGUAGE plpgsql;
+
+CREATE TRIGGER trg_auto_dawca_szpital
+AFTER INSERT ON Oddanie_Zapotrzebowanie
+FOR EACH ROW
+EXECUTE FUNCTION automatyczny_dawca_szpital();
+
 -- ==========================================
 -- DODATKOWE DANE TESTOWE (ROZSZERZENIE)
 -- ==========================================
@@ -485,9 +517,9 @@
 
 -- 4. Zgłoszenia
 insert into Zgloszenia (id_dawcy, data_zgloszenia, status) values
-((select id_dawcy from Dawcy where pesel='85021411223'), '2025-12-08', 'zaakceptowane'), -- Tomasz
-((select id_dawcy from Dawcy where pesel='99032055443'), '2025-12-09', 'zaakceptowane'), -- Ewa
-((select id_dawcy from Dawcy where pesel='95111122334'), '2025-12-10', 'zaakceptowane'); -- Kamil
+((select id_dawcy from Dawcy where pesel='85021411223'), '2025-12-08', 'zrealizowane'), -- Tomasz
+((select id_dawcy from Dawcy where pesel='99032055443'), '2025-12-09', 'zrealizowane'), -- Ewa
+((select id_dawcy from Dawcy where pesel='95111122334'), '2025-12-10', 'zrealizowane'); -- Kamil
 
 
 -- 5. Oddania Krwi
