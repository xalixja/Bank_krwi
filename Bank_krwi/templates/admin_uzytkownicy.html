{% extends "base.html" %}

{% block title %}Zarządzanie użytkownikami{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Użytkownicy</h1>
    <a href="/admin" class="btn btn-outline-secondary">⬅ Powrót do panelu</a>
</div>

<div class="card shadow-sm mb-5">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Login</th>
                    <th>Rola</th>
                    <th>Data rejestracji</th>
                    <th>Akcja</th>
                    <th>Usuń</th>
                </tr>
                </thead>
                <tbody>
                {% for u in uzytkownicy %}
                <tr>
                    <td>{{ u[0] }}</td>
                    <td class="fw-bold">{{ u[1] }}</td>

                    <td><span class="badge bg-krew text-white">{{ u[2] }}</span></td>

                    <td>{{ u[3] }}</td>

                    <td>
                        <button class="btn btn-sm btn-warning" onclick="toggleEdit({{ u[0] }})">
                            Edytuj
                        </button>
                    </td>

                    <td>
                        <form method="POST" action="/admin/uzytkownicy/usun/{{ u[0] }}" onsubmit="return confirm('Czy na pewno usunąć tego użytkownika?');">
                            <button type="submit" class="btn btn-sm btn-danger">Usuń</button>
                        </form>
                    </td>
                </tr>

                <tr id="edit-{{ u[0] }}" style="display:none;" class="table-krew-light">
                    <td colspan="6">
                        <div class="p-3">
                            <h5 class="text-danger">Edytuj użytkownika #{{ u[0] }}</h5>
                            <form method="POST" action="/admin/uzytkownicy/edytuj/{{ u[0] }}" class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Login</label>
                                    <input type="text" name="login" value="{{ u[1] }}" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Nowe hasło</label>
                                    <input type="password" name="haslo" class="form-control" placeholder="Pozostaw puste, aby nie zmieniać">
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-success">Zapisz zmiany</button>
                                    <button type="button" class="btn btn-secondary" onclick="toggleEdit({{ u[0] }})">Anuluj</button>
                                </div>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-krew text-white">
        <h3 class="h5 mb-0">Dodaj nowego użytkownika</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="/admin/uzytkownicy/dodaj">

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Login</label>
                    <input name="login" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Hasło</label>
                    <input name="haslo" type="password" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Rola</label>
                    <select name="rola" id="rola" class="form-select" onchange="pokazPola()">
                        <option value="ADMIN">ADMIN</option>
                        <option value="PRACOWNIK">PRACOWNIK</option>
                        <option value="SZPITAL">SZPITAL</option>
                        <option value="DAWCA">DAWCA</option>
                    </select>
                </div>
            </div>

            <hr>

            <div id="dawca" style="display:none;">
                <h5 class="text-danger mt-3">Dane dawcy</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Imię</label>
                        <input name="d_imie" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nazwisko</label>
                        <input name="d_nazwisko" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">PESEL</label>
                        <input name="d_pesel" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Grupa krwi</label>
                        <input name="d_grupa" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Rh</label>
                        <input name="d_rh" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Kontakt</label>
                        <input name="d_kontakt" class="form-control">
                    </div>
                </div>
            </div>

            <div id="pracownik" style="display:none;">
                <h5 class="text-danger mt-3">Dane pracownika</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Imię</label>
                        <input name="p_imie" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nazwisko</label>
                        <input name="p_nazwisko" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Stanowisko</label>
                        <input name="p_stanowisko" class="form-control">
                    </div>
                </div>
            </div>

            <div id="szpital" style="display:none;">
                <h5 class="text-danger mt-3">Dane szpitala</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nazwa szpitala</label>
                        <input name="s_nazwa" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Adres</label>
                        <input name="s_adres" class="form-control">
                    </div>
                </div>
            </div>

            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-krew px-4">Dodaj użytkownika</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function toggleEdit(id) {
        const row = document.getElementById("edit-" + id);
        if (row.style.display === "none") {
            row.style.display = "table-row";
        } else {
            row.style.display = "none";
        }
    }

    function pokazPola() {
        let rola = document.getElementById("rola").value;
        document.getElementById("dawca").style.display = "none";
        document.getElementById("pracownik").style.display = "none";
        document.getElementById("szpital").style.display = "none";

        if (rola === "DAWCA") {
            document.getElementById("dawca").style.display = "block";
        } else if (rola === "PRACOWNIK") {
            document.getElementById("pracownik").style.display = "block";
        } else if (rola === "SZPITAL") {
            document.getElementById("szpital").style.display = "block";
        }
    }
    window.onload = pokazPola;
</script>
{% endblock %}